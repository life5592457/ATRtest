<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç©º-ATRç§»å‹•åœæä¸‹å–®</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body onload="initForm()">
    <div class="container mt-5">
        <h2>å¤šç©º-ATRç§»å‹•åœæä¸‹å–®(ver:2025101301)</h2>
        <form id="mainForm">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="long">ä½œå¤š</label>
                    <select class="form-control" id="long">
                        <option value="BTC" selected>BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="ETC">ETC</option>
                        <option value="ATOM">ATOM</option>
                        <option value="POL">POL</option>
                        <option value="ADA">ADA</option>
                        <option value="AVAX">AVAX</option>
                        <option value="DOT">DOT</option>
                        <option value="BNB">BNB</option>
                        <option value="SOL">SOL</option>
                        <option value="XRP">XRP</option>
                        <option value="LTC">LTC</option>
                        <option value="DOGE">DOGE</option>
                    </select>
                    <input type="text" class="form-control" id="long_list" placeholder="æ‰‹å‹•è¼¸å…¥ä½œå¤šPoolåˆ—è¡¨">
                </div>
                <div class="form-group col-md-6">
                    <label for="short">ä½œç©º</label>
                    <select class="form-control" id="short">
                        <option value="BTC">BTC</option>
                        <option value="ETH" selected>ETH</option>
                        <option value="ETC">ETC</option>
                        <option value="ATOM">ATOM</option>
                        <option value="POL">POL</option>
                        <option value="ADA">ADA</option>
                        <option value="AVAX">AVAX</option>
                        <option value="DOT">DOT</option>
                        <option value="BNB">BNB</option>
                        <option value="SOL">SOL</option>
                        <option value="XRP">XRP</option>
                        <option value="LTC">LTC</option>
                        <option value="DOGE">DOGE</option>
                    </select>
                    <input type="text" class="form-control" id="short_list" placeholder="æ‰‹å‹•è¼¸å…¥ä½œç©ºPoolåˆ—è¡¨">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="RPercent">1Rå¹¾%</label>
                    <input type="text" class="form-control" id="RPercent" placeholder="è¼¸å…¥1Rå¹¾%">
                </div>
                <div class="form-group col-md-6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="SL">SL (è‹¥åœæç‚ºæ­£æ•¸ä¸‹é¢é¸å–®è«‹é¸æ“‡æ­£)(å–®ä½ç‚ºR)</label>
                    <div class="form-inline">
                        <select class="form-control" id="isSLMinus">
                            <option value="SL_Minus" selected>è² </option>
                            <option value="SL_Plus">æ­£</option>
                        </select>
                        <input type="text" class="form-control" id="SL" placeholder="è¼¸å…¥SLçš„R">
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label for="TP">TP(å–®ä½ç‚ºR) - ATRæ¨¡å¼å»ºè­°è¨­ç‚ºé«˜å€¼</label>
                    <input type="text" class="form-control" id="TP" placeholder="è¼¸å…¥TPçš„R (å»ºè­°999)" value="999">
                </div>
            </div>

            <!-- è³‡ç”¢ç‹€æ³é¡¯ç¤ºå€å¡Š -->
            <div class="alert alert-info" role="alert" id="asset-info-block" style="display: none;">
                <h6 class="alert-heading">ğŸ’° è³‡ç”¢ç‹€æ³</h6>
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted">åŸå§‹è³‡ç”¢:</small><br>
                        <strong id="initial-capital" class="text-dark">-</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">ç´¯ç©ç›ˆè™§:</small><br>
                        <strong id="total-pnl" class="text-dark">-</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">ç•¶å‰è³‡ç”¢:</small><br>
                        <strong id="current-capital" class="text-primary">-</strong>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">å»ºè­°ä¸‹å–®é‡‘é¡ (1.0%):</small><br>
                        <strong id="capital-1-percent" class="text-success">-</strong>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">å»ºè­°ä¸‹å–®é‡‘é¡ (0.5%):</small><br>
                        <strong id="capital-0-5-percent" class="text-success">-</strong>
                    </div>
                </div>
            </div>
            <div class="alert alert-warning" role="alert" id="asset-warning-block" style="display: none;">
                <small>âš ï¸ å°šæœªè¨­å®šåŸå§‹è³‡ç”¢ï¼Œè«‹ä½¿ç”¨ <code>/set_capital</code> æŒ‡ä»¤è¨­å®š</small>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="R">ä¸‹å–®é‡‘é¡(å–®ä½ç‚ºU)</label>
                    <input type="text" class="form-control" id="R" placeholder="è¼¸å…¥ä¸‹å–®é‡‘é¡">
                </div>
                <div class="form-group col-md-6">
                    <label for="Leverage">æ§“æ¡¿å€æ•¸ ä¼°ç®—ä¿è­‰é‡‘ï¼š<span id="margin" class="text-primary font-weight-bold">-</span></label>
                    <input type="text" class="form-control" id="Leverage" placeholder="è¼¸å…¥æ§“æ¡¿å€æ•¸">
                    <div class="mt-2">
                        <small class="text-muted">å¯ç”¨é¤˜é¡: <span id="available-balance" class="font-weight-bold text-info">è¼‰å…¥ä¸­...</span></small>
                        <small id="margin-sufficient-status" class="ml-3"></small>
                    </div>
                </div>
            </div>

            <!-- ATRå°ˆç”¨è¨­å®š -->
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="atr_period">ATRé€±æœŸ</label>
                    <select class="form-control" id="atr_period">
                        <option value="10">10</option>
                        <option value="14" selected>14</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="atr_multiplier">ATRå€æ•¸</label>
                    <select class="form-control" id="atr_multiplier">
                        <option value="1.5">1.5</option>
                        <option value="2.0">2.0</option>
                        <option value="2.5">2.5</option>
                        <option value="3.0" selected>3.0</option>
                        <option value="3.5">3.5</option>
                        <option value="4.0">4.0</option>
                        <option value="5.0">5.0</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="atr_scaling_enabled">
                        <label class="form-check-label" for="atr_scaling_enabled">
                            å•Ÿç”¨ATRå‹•æ…‹åŠ ç¢¼
                        </label>
                    </div>
                </div>
                <div class="form-group col-md-6" id="scaling_multiplier_group" style="display: none;">
                    <label for="atr_scaling_multiplier">å‹•æ…‹åŠ ç¢¼å€æ•¸ (1-999) ä¼°ç®—åŠ ç¢¼å¾Œä¿è­‰é‡‘ï¼š<span id="scaled-margin" class="text-warning font-weight-bold">-</span></label>
                    <input type="number" class="form-control" id="atr_scaling_multiplier"
                           placeholder="è¼¸å…¥åŠ ç¢¼å€æ•¸ä¸Šé™" value="2.0" min="1.0" max="999" step="0.1">
                    <div class="mt-2">
                        <small class="text-muted">å¯ç”¨é¤˜é¡: <span id="scaled-available-balance" class="font-weight-bold text-info">-</span></small>
                        <small id="scaled-margin-sufficient-status" class="ml-3"></small>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <h6>ATRç§»å‹•åœæèªªæ˜ï¼š</h6>
                <ul>
                    <li>ATRæœƒæ ¹æ“šå¤šç©ºå°çš„åƒ¹å·®æ³¢å‹•æ€§å‹•æ…‹èª¿æ•´åœæä½ç½®</li>
                    <li>ç•¶åƒ¹æ ¼å°æ‚¨æœ‰åˆ©æ™‚ï¼Œåœææœƒè‡ªå‹•å‘æœ‰åˆ©æ–¹å‘ç§»å‹•</li>
                    <li>å»ºè­°å°‡TPè¨­ç‚ºé«˜å€¼(å¦‚999)ï¼Œè®“ATRç³»çµ±ç®¡ç†å‡ºå ´</li>
                    <li>å•Ÿç”¨å‹•æ…‹åŠ ç¢¼å¾Œï¼Œç³»çµ±æœƒåœ¨ç‰¹å®šæ¢ä»¶ä¸‹è‡ªå‹•åŠ å€‰</li>
                </ul>
            </div>

            <button type="button" class="btn btn-primary" onclick="concatenateAndCopy()">é€å‡ºATRä¸‹å–®è³‡æ–™</button>
            <button type="button" class="btn btn-secondary" onclick="cancelNewOrder()">å–æ¶ˆä¸‹å–®</button>
        </form>
        <br/>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('click', (event) => {
            const tags = ['INPUT', 'TEXTAREA']
            const focused = document.activeElement

            if (focused && focused !== event.target && tags.includes(focused.tagName)) {
                focused.blur()
            }
        })

        const telegram = Telegram.WebApp;
        telegram.ready();

        // å…¨åŸŸè®Šæ•¸å„²å­˜å¯ç”¨é¤˜é¡
        let availableBalance = 0;

        // å³æ™‚æ›´æ–°ä¿è­‰é‡‘ä¼°ç®—
        function updateMarginEstimate() {
            const R = parseFloat(document.getElementById('R').value) || 0;
            const SL = parseFloat(document.getElementById('SL').value) || 0;
            const Leverage = parseFloat(document.getElementById('Leverage').value) || 0;

            const marginElement = document.getElementById('margin');
            const statusElement = document.getElementById('margin-sufficient-status');

            if (R > 0 && SL > 0 && Leverage > 0) {
                const marginValue = (R / (Math.abs(SL) / 100) / Leverage * 2).toFixed(2);
                marginElement.textContent = `$${marginValue}`;

                // æª¢æŸ¥ä¿è­‰é‡‘å……è¶³æ€§
                if (availableBalance > 0) {
                    const sufficient = availableBalance >= parseFloat(marginValue);
                    statusElement.innerHTML = sufficient
                        ? '<span style="color:green">âœ… ä¿è­‰é‡‘å……è¶³</span>'
                        : '<span style="color:red">âŒ ä¿è­‰é‡‘ä¸è¶³</span>';
                } else {
                    statusElement.innerHTML = '';
                }

                // ğŸ†• è¨ˆç®—ä¸¦é¡¯ç¤ºåŠ ç¢¼å¾Œä¿è­‰é‡‘ï¼ˆç¨ç«‹åˆ¤å®šï¼‰
                updateScaledMarginEstimate(parseFloat(marginValue));
            } else {
                marginElement.textContent = '-';
                statusElement.innerHTML = '';

                // ğŸ†• æ¸…ç©ºåŠ ç¢¼å¾Œä¿è­‰é‡‘é¡¯ç¤º
                updateScaledMarginEstimate(0);
            }
        }

        // ğŸ†• æ–°å¢ï¼šæ›´æ–°åŠ ç¢¼å¾Œä¿è­‰é‡‘ä¼°ç®—ï¼ˆç¨ç«‹æ–¼åŸºç¤ä¿è­‰é‡‘åˆ¤å®šï¼‰
        function updateScaledMarginEstimate(baseMargin) {
            const scaledMarginElement = document.getElementById('scaled-margin');
            const scaledBalanceElement = document.getElementById('scaled-available-balance');
            const scaledStatusElement = document.getElementById('scaled-margin-sufficient-status');

            // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨å‹•æ…‹åŠ ç¢¼
            const scalingEnabled = document.getElementById('atr_scaling_enabled').checked;

            if (!scalingEnabled) {
                // æœªå•Ÿç”¨å‹•æ…‹åŠ ç¢¼æ™‚ä¸åŸ·è¡Œï¼ˆçˆ¶å…ƒç´ å·² display:noneï¼‰
                return;
            }

            if (baseMargin > 0) {
                // è®€å–å‹•æ…‹åŠ ç¢¼å€æ•¸
                const scalingMultiplier = parseFloat(document.getElementById('atr_scaling_multiplier').value) || 1.0;

                // è¨ˆç®—åŠ ç¢¼å¾Œä¿è­‰é‡‘
                const scaledMarginValue = (baseMargin * scalingMultiplier).toFixed(2);

                // é¡¯ç¤ºåŠ ç¢¼å¾Œä¿è­‰é‡‘
                scaledMarginElement.textContent = `$${scaledMarginValue}`;

                // é¡¯ç¤ºå¯ç”¨é¤˜é¡èˆ‡å……è¶³æ€§åˆ¤å®šï¼ˆç¨ç«‹æ–¼åŸºç¤ä¿è­‰é‡‘ï¼‰
                if (availableBalance > 0) {
                    scaledBalanceElement.textContent = `$${availableBalance.toFixed(2)}`;

                    // ========== é—œéµï¼šç¨ç«‹åˆ¤å®šåŠ ç¢¼å¾Œä¿è­‰é‡‘å……è¶³æ€§ ==========
                    const scaledSufficient = availableBalance >= parseFloat(scaledMarginValue);
                    scaledStatusElement.innerHTML = scaledSufficient
                        ? '<span style="color:green">âœ… ä¿è­‰é‡‘å……è¶³</span>'
                        : '<span style="color:red">âŒ ä¿è­‰é‡‘ä¸è¶³</span>';
                } else {
                    scaledBalanceElement.textContent = 'æœªæä¾›';
                    scaledStatusElement.innerHTML = '';
                }
            } else {
                // æ¸…ç©ºé¡¯ç¤º
                scaledMarginElement.textContent = '-';
                scaledBalanceElement.textContent = '-';
                scaledStatusElement.innerHTML = '';
            }
        }

        // å‹•æ…‹åŠ ç¢¼é¸é …åˆ‡æ›
        document.getElementById('atr_scaling_enabled').onchange = function() {
            const scalingGroup = document.getElementById('scaling_multiplier_group');
            scalingGroup.style.display = this.checked ? 'block' : 'none';

            // ğŸ†• åˆ‡æ›æ™‚é‡æ–°è¨ˆç®—ï¼ˆç¢ºä¿å³æ™‚æ›´æ–°ï¼‰
            updateMarginEstimate();
        };

        document.getElementById('long_list').onchange = function() {
            const listValue = this.value.replace(/\s/g, '');
            const selectElement = document.getElementById('long');
            if (listValue) {
                l = listValue.split(',');
                selectElement.innerHTML = '';
                for (i = 0; i < l.length; i++) {
                    const option = new Option(l[i], l[i]);
                    selectElement.add(option);
                    selectElement.value = l[i];
                };
            } else {
                defaultCoins = ['BTC', 'ETH', 'ETC', 'ATOM', 'POL', 'ADA', 'AVAX', 'DOT', 'BNB', 'SOL', 'XRP', 'LTC', 'DOGE'];
                selectElement.innerHTML = '';
                for (i = 0; i < defaultCoins.length; i++) {
                    const option = new Option(defaultCoins[i], defaultCoins[i]);
                    selectElement.add(option);
                };
                selectElement.value = 'BTC';
            }
            localStorage.setItem('ATR_long_list', listValue);
        };

        document.getElementById('short_list').onchange = function() {
            const listValue = this.value.replace(/\s/g, '');
            const selectElement = document.getElementById('short');
            if (listValue) {
                l = listValue.split(',');
                selectElement.innerHTML = '';
                for (i = 0; i < l.length; i++) {
                    const option = new Option(l[i], l[i]);
                    selectElement.add(option);
                    selectElement.value = l[i];
                };
            } else {
                defaultCoins = ['BTC', 'ETH', 'ETC', 'ATOM', 'POL', 'ADA', 'AVAX', 'DOT', 'BNB', 'SOL', 'XRP', 'LTC', 'DOGE'];
                selectElement.innerHTML = '';
                for (i = 0; i < defaultCoins.length; i++) {
                    const option = new Option(defaultCoins[i], defaultCoins[i]);
                    selectElement.add(option);
                };
                selectElement.value = 'ETH';
            }
            localStorage.setItem('ATR_short_list', listValue);
        };

        function initForm() {
            // å¾URLåƒæ•¸ç²å–é è¨­å€¼
            const urlParams = new URLSearchParams(window.location.search);
            const atrEnabled = urlParams.get('atrEnabled');
            const atrPeriod = urlParams.get('atrPeriod');
            const atrMultiplier = urlParams.get('atrMultiplier');

            // å¾ URL åƒæ•¸ç²å–å¯ç”¨é¤˜é¡
            const accountBalanceParam = urlParams.get('accountBalance');
            if (accountBalanceParam) {
                availableBalance = parseFloat(accountBalanceParam);
                document.getElementById('available-balance').textContent = `$${availableBalance.toFixed(2)}`;
                console.log(`[AVAILABLE-BALANCE] æ¥æ”¶åˆ°å¯ç”¨é¤˜é¡: $${availableBalance.toFixed(2)}`);
            } else {
                document.getElementById('available-balance').textContent = 'æœªæä¾›';
            }

            // è¨­ç½®ATRé è¨­å€¼
            if (atrPeriod) {
                document.getElementById('atr_period').value = atrPeriod;
            }
            if (atrMultiplier) {
                document.getElementById('atr_multiplier').value = atrMultiplier;
            }

            // Read values from localStorage
            const longValue = localStorage.getItem('ATR_long');
            const shortValue = localStorage.getItem('ATR_short');
            const RValue = localStorage.getItem('ATR_R');
            const RPercentValue = localStorage.getItem('ATR_RPercent');
            const SLValue = localStorage.getItem('ATR_SL');
            const TPValue = localStorage.getItem('ATR_TP');
            const LeverageValue = localStorage.getItem('ATR_Leverage');
            const longListValue = localStorage.getItem('ATR_long_list');
            const shortListValue = localStorage.getItem('ATR_short_list');
            const atrPeriodValue = localStorage.getItem('ATR_period');
            const atrMultiplierValue = localStorage.getItem('ATR_multiplier');
            const atrScalingEnabledValue = localStorage.getItem('ATR_scaling_enabled');
            const atrScalingMultiplierValue = localStorage.getItem('ATR_scaling_multiplier');

            if (longListValue) {
                document.getElementById('long_list').value = longListValue;
                const l = longListValue.split(',');
                const longSelectElement = document.getElementById('long');
                longSelectElement.innerHTML = '';
                for (i = 0; i < l.length; i++) {
                    const option = new Option(l[i], l[i]);
                    longSelectElement.add(option);
                };
            }

            if (shortListValue) {
                document.getElementById('short_list').value = shortListValue;
                const l = shortListValue.split(',');
                const shortSelectElement = document.getElementById('short');
                shortSelectElement.innerHTML = '';
                for (i = 0; i < l.length; i++) {
                    const option = new Option(l[i], l[i]);
                    shortSelectElement.add(option);
                };
            }

            // Set values in the form
            if(longValue === null) {
                document.getElementById('long').value = 'BTC';
            } else {
                document.getElementById('long').value = longValue;
            }

            if (longValue && document.getElementById('long').querySelector(`option[value="${longValue}"]`)) {
                document.getElementById('long').value = longValue;
            } else {
                document.getElementById('long').selectedIndex = 0;
            }

            if(shortValue === null) {
                document.getElementById('short').value = 'ETH';
            } else {
                document.getElementById('short').value = shortValue;
            }

            if (shortValue && document.getElementById('short').querySelector(`option[value="${shortValue}"]`)) {
                document.getElementById('short').value = shortValue;
            } else {
                document.getElementById('short').selectedIndex = 0;
            }

            document.getElementById('R').value = RValue;
            document.getElementById('SL').value = SLValue;
            document.getElementById('TP').value = TPValue || '999';
            document.getElementById('RPercent').value = RPercentValue;
            document.getElementById('Leverage').value = LeverageValue;

            // ATR è¨­å®š
            if (atrPeriodValue) {
                document.getElementById('atr_period').value = atrPeriodValue;
            }
            if (atrMultiplierValue) {
                document.getElementById('atr_multiplier').value = atrMultiplierValue;
            }
            if (atrScalingEnabledValue === 'true') {
                document.getElementById('atr_scaling_enabled').checked = true;
                document.getElementById('scaling_multiplier_group').style.display = 'block';
            }
            if (atrScalingMultiplierValue) {
                document.getElementById('atr_scaling_multiplier').value = atrScalingMultiplierValue;
            }

            // ç¶å®šå³æ™‚ä¿è­‰é‡‘è¨ˆç®—äº‹ä»¶
            document.getElementById('R').addEventListener('input', updateMarginEstimate);
            document.getElementById('SL').addEventListener('input', updateMarginEstimate);
            document.getElementById('Leverage').addEventListener('input', updateMarginEstimate);

            // ğŸ†• æ–°å¢ï¼šç¶å®šå‹•æ…‹åŠ ç¢¼å€æ•¸è¼¸å…¥äº‹ä»¶
            document.getElementById('atr_scaling_multiplier').addEventListener('input', updateMarginEstimate);

            // åˆå§‹è¨ˆç®—ä¸€æ¬¡
            updateMarginEstimate();

            // è¼‰å…¥è³‡ç”¢è³‡è¨Š
            loadAssetInfo();
        }

        // è¼‰å…¥ä¸¦é¡¯ç¤ºè³‡ç”¢è³‡è¨Š
        function loadAssetInfo() {
            try {
                // ğŸ†• å¾ URL åƒæ•¸è®€å–è³‡ç”¢è³‡è¨Šï¼ˆç”± Bot è¨ˆç®—å¾Œå‚³éï¼‰
                const urlParams = new URLSearchParams(window.location.search);

                const initialCapital = parseFloat(urlParams.get('initialCapital')) || 0;
                const totalPnL = parseFloat(urlParams.get('totalPnL')) || 0;
                const currentCapital = parseFloat(urlParams.get('currentCapital')) || 0;
                const csvCount = parseInt(urlParams.get('csvCount')) || 0;

                // å¦‚æœæ²’æœ‰è³‡ç”¢è³‡è¨Šï¼ˆæœªè¨­å®šæˆ– URL åƒæ•¸ä¸å­˜åœ¨ï¼‰ï¼Œé¡¯ç¤ºè­¦å‘Š
                if (initialCapital === 0 && totalPnL === 0) {
                    document.getElementById('asset-warning-block').style.display = 'block';
                    console.log('[ASSET-INFO-ERROR] å°šæœªè¨­å®šåŸå§‹è³‡ç”¢');
                    return;
                }

                // è¨ˆç®—å»ºè­°ä¸‹å–®é‡‘é¡
                const capital1Percent = currentCapital * 0.01;
                const capital05Percent = currentCapital * 0.005;

                // é¡¯ç¤ºè³‡è¨Š
                document.getElementById('initial-capital').textContent = `${initialCapital.toFixed(2)} U`;
                document.getElementById('total-pnl').textContent = `${totalPnL >= 0 ? '+' : ''}${totalPnL.toFixed(2)} U (${csvCount} ç­†)`;
                document.getElementById('current-capital').textContent = `${currentCapital.toFixed(2)} U`;
                document.getElementById('capital-1-percent').textContent = `${capital1Percent.toFixed(2)} U`;
                document.getElementById('capital-0-5-percent').textContent = `${capital05Percent.toFixed(2)} U`;

                // é¡¯ç¤ºè³‡ç”¢å€å¡Š
                document.getElementById('asset-info-block').style.display = 'block';
                console.log(`[ASSET-INFO] åŸå§‹è³‡ç”¢: ${initialCapital}, ç´¯ç©ç›ˆè™§: ${totalPnL}, ç•¶å‰è³‡ç”¢: ${currentCapital}`);

            } catch (error) {
                // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
                document.getElementById('asset-warning-block').style.display = 'block';
                console.log(`[ASSET-INFO-ERROR] ${error.message}`);
            }
        }

        function concatenateAndCopy() {
            const long = document.getElementById('long').value;
            const short = document.getElementById('short').value;
            const R = document.getElementById('R').value;
            const RPercent = document.getElementById('RPercent').value;
            var SL = document.getElementById('SL').value;
            let TP = document.getElementById('TP').value;
            const Leverage = document.getElementById('Leverage').value;
            const margin = document.getElementById('margin');
            const isSLMinus = document.getElementById('isSLMinus').value;

            // ATR åƒæ•¸
            const atr_period = document.getElementById('atr_period').value;
            const atr_multiplier = document.getElementById('atr_multiplier').value;
            const atr_scaling_enabled = document.getElementById('atr_scaling_enabled').checked;
            const atr_scaling_multiplier = document.getElementById('atr_scaling_multiplier').value;

            if (long === short) {
                alert('ä½œå¤šèˆ‡ä½œç©ºæ¨™çš„ä¸å¯ç›¸åŒ');
                return;
            }

            if (R === '' || SL === '' || TP === '' || Leverage === '' || RPercent === '') {
                alert('è«‹è¼¸å…¥1Rå¹¾%, ä¸‹å–®é‡‘é¡, SL, TP, æ§“æ¡¿å€æ•¸');
                return;
            }

            if (isNaN(R) || isNaN(SL) || isNaN(TP) || isNaN(Leverage) || isNaN(RPercent)) {
                alert('1Rå¹¾%, ä¸‹å–®é‡‘é¡, SL, TP, æ§“æ¡¿å€æ•¸å¿…é ˆç‚ºæ•¸å­—');
                return;
            }

            const marginValue = (R / (Math.abs(SL) / 100) / Leverage*2).toFixed(2);
            margin.innerHTML = `ä¼°ç®—ä¿è­‰é‡‘ï¼š${marginValue}U`;

            // Store values in localStorage
            localStorage.setItem('ATR_long', long);
            localStorage.setItem('ATR_short', short);
            localStorage.setItem('ATR_R', R);
            localStorage.setItem('ATR_RPercent', RPercent);
            localStorage.setItem('ATR_SL', SL);
            localStorage.setItem('ATR_TP', TP);
            localStorage.setItem('ATR_Leverage', Leverage);
            localStorage.setItem('ATR_period', atr_period);
            localStorage.setItem('ATR_multiplier', atr_multiplier);
            localStorage.setItem('ATR_scaling_enabled', atr_scaling_enabled);
            localStorage.setItem('ATR_scaling_multiplier', atr_scaling_multiplier);

            if (isSLMinus === 'SL_Minus') {
                SL = -SL;
            }
            const orig_TP = TP;
            const orig_SL = SL;

            SL = Number((SL * RPercent).toFixed(3));
            TP = Number(Math.abs(TP * RPercent).toFixed(3));

            // ATR æ¨¡å¼ä¸ä½¿ç”¨å‚³çµ±ä¿æœ¬ç§»å‹•åœæï¼Œå…¨éƒ¨è¨­ç‚º0
            const preservePercent = 0;
            const savePercent = 0;
            const trailingCondition = 0;
            const trailingAmount = 0;

            var result = '';
            result = 'long=' + long + '&short=' + short + '&RPercent=' + RPercent + '&SL=' + SL + '&TP=' + TP + '&R=' + R + '&Leverage=' + Leverage +
                     '&preservePercent=' + preservePercent + '&savePercent=' + savePercent + '&trailingCondition=' + trailingCondition + '&trailingAmount=' + trailingAmount +
                     '&atr_enabled=true&atr_period=' + atr_period + '&atr_multiplier=' + atr_multiplier +
                     '&atr_scaling_enabled=' + atr_scaling_enabled + '&atr_scaling_multiplier=' + atr_scaling_multiplier +
                     '&limit_quantity_multiplier=' + atr_scaling_multiplier;

            var checkResult = 'è«‹ç¢ºèªATRåƒæ•¸:\nä½œå¤š:' + long + '\nä½œç©º:' + short + '\n1Rå¹¾%:'+ RPercent + '%\nSL:' + SL + '%('+ orig_SL + 'R)\nTP:' + TP + '%(' + orig_TP +'R)\nä¸‹å–®é‡‘é¡:' + R + ' U\næ§“æ¡¿å€æ•¸:' + Leverage + '(ä¼°ç®—ä¿è­‰é‡‘ï¼š' + marginValue +'U)\n';
            checkResult += 'ATRé€±æœŸ: ' + atr_period + '\nATRå€æ•¸: ' + atr_multiplier + '\n';
            checkResult += 'å‹•æ…‹åŠ ç¢¼: ' + (atr_scaling_enabled ? 'å•Ÿç”¨(' + atr_scaling_multiplier + 'å€)' : 'é—œé–‰') + '\n';
            checkResult += 'ATRå°‡å‹•æ…‹ç®¡ç†åœæä½ç½®';

            telegram.showConfirm(checkResult, function(isOK){
                if (isOK) {
                    telegram.sendData(result);
                }
            })

            return;
        }

        function cancelNewOrder() {
            telegram.showConfirm("å–æ¶ˆä¸‹å–®?", function(isOK){
                if (isOK) {
                    telegram.sendData("cancelNewOrder");
                }
            })
        }
    </script>
</body>
</html>