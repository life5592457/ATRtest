<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç©º-èª¿æ•´å€‰ä½æ•¸å€¼</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* æ‹‰æ¡¿å¼æ§“æ¡¿èª¿æ•´æ¨£å¼ */
        .leverage-slider-container {
            position: relative;
            margin: 20px 0;
        }

        .leverage-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #28a745 0%, #ffc107 50%, #dc3545 100%);
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }

        .leverage-slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #007bff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .leverage-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            border-color: #0056b3;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .leverage-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #007bff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider-ticks {
            position: relative;
            margin-top: 10px;
            height: 30px;
            width: 100%;
        }

        .tick {
            font-size: 11px;
            color: #666;
            cursor: pointer;
            padding: 1px 3px;
            border-radius: 3px;
            transition: all 0.2s ease;
            position: absolute;
            white-space: nowrap;
            min-width: 20px;
            text-align: center;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
        }

        .tick.max-leverage {
            color: #dc3545 !important;
            font-weight: bold;
        }

        .tick:hover {
            background-color: #f8f9fa;
            color: #007bff;
        }

        .tick.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        /* ä¿®å¾©ï¼šéš±è—é‡è¤‡çš„å……è¶³æ€§é¡¯ç¤ºå€åŸŸ */
        #position-sufficiency {
            display: none !important;
        }

        /* æ–°å¢ï¼šç¨ç«‹çš„æ§“æ¡¿èªªæ˜å®¹å™¨ */
        .leverage-info-container {
            margin-top: 15px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            text-align: center;
        }

        #live-leverage-analysis {
            border: 2px solid #e9ecef !important;
            transition: all 0.3s ease;
        }

        #live-leverage-analysis.sufficient {
            border-color: #28a745 !important;
            background-color: #f8fff9 !important;
        }

        #live-leverage-analysis.warning {
            border-color: #ffc107 !important;
            background-color: #fffbf0 !important;
        }

        #live-leverage-analysis.danger {
            border-color: #dc3545 !important;
            background-color: #fff5f5 !important;
        }

        #current-leverage-display {
            font-size: 16px;
            padding: 6px 12px;
            margin-left: 10px;
        }

        .form-control-range:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body onload="initForm()">
    <div class="container mt-5">
        <h2>å¤šç©º-èª¿æ•´å€‰ä½æ•¸å€¼(ver:2025082401)</h2>
        <form id="mainForm">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="orderId"></label>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="long">ä½œå¤š</label>
                </div>
                <div class="form-group col-md-6">
                    <label id="short">ä½œç©º</label>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="RPercent">1Rå¹¾%:</label>
                </div>
                <div class="form-group col-md-6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="SL">SL (è‹¥åœæç‚ºæ­£æ•¸ä¸‹é¢é¸å–®è«‹é¸æ“‡æ­£)(å–®ä½ç‚ºR)</label>
                    <div class="form-inline">
                        <select class="form-control" id="isSLMinus">
                            <option value="SL_Minus" selected>è² </option>
                            <option value="SL_Plus">æ­£</option>
                        </select>
                        <input type="text" class="form-control" id="SL" placeholder="è¼¸å…¥SLçš„R">
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label for="TP">TP(å–®ä½ç‚ºR)</label>
                    <input type="text" class="form-control" id="TP" placeholder="è¼¸å…¥TPçš„R">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="preserveType">ä¿æœ¬/ç§»å‹•åœæ</label>
                    <select class="form-control" id="preserveType" onchange="toggleInputs()">
                        <option value="preserve" selected>ä¿æœ¬</option>
                        <option value="trailing">ç§»å‹•åœæ</option>
                        <option value="preserve_trailing">ä¿æœ¬+ç§»å‹•åœæ</option>
                        <option value="none">ä¸å•Ÿç”¨</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                </div>
            </div>
            <div class="form-row" id="preserveInputs">
                <div class="form-group col-md-6">
                    <label for="preservePercent">è‡ªå‹•ä¿æœ¬æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, è«‹è¼¸å…¥å¤§æ–¼0ä¹‹æ•¸å­—)</label>
                    <input type="text" class="form-control" id="preservePercent" placeholder="è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, 0ç‚ºä¸å•Ÿå‹•è‡ªå‹•ä¿æœ¬)">
                </div>
                <div class="form-group col-md-6">
                    <label for="savePercent">ä¿æœ¬Ræ•¸</label>
                    <input type="text" class="form-control" id="savePercent" placeholder="è¼¸å…¥ä¿æœ¬Ræ•¸">
                </div>
            </div>
            <div class="form-row" id="trailingInputs" style="display:none">
                <div class="form-group col-md-6">
                    <label for="trailingCondition">ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, è«‹è¼¸å…¥å¤§æ–¼0ä¹‹æ•¸å­—)</label>
                    <input type="text" class="form-control" id="trailingCondition" placeholder="è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, 0ç‚ºä¸å•Ÿå‹•ç§»å‹•åœæ)">
                </div>
                <div class="form-group col-md-6">
                    <label for="trailingAmount">å›åç§»å‹•Ræ•¸</label>
                    <input type="text" class="form-control" id="trailingAmount" placeholder="è¼¸å…¥ç§»å‹•Ræ•¸">
                </div>
            </div>
        </form>

        <!-- æ§“æ¡¿åˆ†æå»ºè­°å€åŸŸ -->
        <div id="leverage-analysis" class="mt-4 p-3 border rounded" style="display:none;">
            <h4>ğŸ” æ§“æ¡¿åˆ†æå»ºè­° <small class="text-muted">(åƒ…ä¾›åƒè€ƒ)</small></h4>

            <!-- æ§“æ¡¿åŸºæœ¬ä¿¡æ¯é¡¯ç¤ºå€åŸŸ -->
            <div id="leverage-info" class="mb-3">
                <!-- å‹•æ…‹æ›´æ–°çš„æ§“æ¡¿åŸºæœ¬ä¿¡æ¯ -->
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h6>åˆå§‹æŒå€‰åˆ†æ:</h6>
                    <div id="initial-position-info" class="small">
                        <div>â€¢ é•·å€‰: <span id="long-notional">-</span></div>
                        <div>â€¢ ç©ºå€‰: <span id="short-notional">-</span></div>
                        <div>â€¢ å¹³å‡åç¾©åƒ¹å€¼: <span id="avg-notional">-</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>åŠ ç¢¼è¨­å®šåˆ†æ:</h6>
                    <div id="scaling-config-info" class="small">
                        <div>â€¢ è¨­å®šä¸Šé™å€æ•¸: <span id="scaling-multiplier">-</span>x</div>
                        <div>â€¢ æœ€å¤§é æœŸæŒå€‰: <span id="max-expected">-</span></div>
                    </div>
                </div>
            </div>

            <!-- æŒå€‰å……è¶³æ€§é¡¯ç¤ºå€åŸŸ -->
            <div id="position-sufficiency" class="mb-3">
                <!-- å‹•æ…‹æ›´æ–°çš„æŒå€‰å……è¶³æ€§ä¿¡æ¯ -->
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>ç•¶å‰æ§“æ¡¿åˆ†æ (<span id="current-leverage-text">-</span>x):</h6>
                    <div id="current-leverage-status" class="small">
                        <div id="long-limit-status">â€¢ <span id="long-symbol-text">-</span> æŒå€‰ä¸Šé™: <span id="long-limit">-</span> <span id="long-sufficient">-</span></div>
                        <div id="short-limit-status">â€¢ <span id="short-symbol-text">-</span> æŒå€‰ä¸Šé™: <span id="short-limit">-</span> <span id="short-sufficient">-</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>ä¿è­‰é‡‘éœ€æ±‚:</h6>
                    <div id="margin-analysis" class="small">
                        <div>â€¢ ç›®å‰ä¿è­‰é‡‘: <span id="current-margin">-</span></div>
                        <div>â€¢ æœ€å¤§ä¿è­‰é‡‘: <span id="max-margin">-</span></div>
                        <div>â€¢ ä¿è­‰é‡‘å¢åŠ : <span id="margin-increase">-</span></div>
                    </div>
                </div>
            </div>

            <div id="leverage-recommendation" class="mt-3 p-2 rounded">
                <!-- å‹•æ…‹é¡¯ç¤ºå»ºè­°å…§å®¹ -->
            </div>

            <!-- æ‹‰æ¡¿å¼æ§“æ¡¿èª¿æ•´æ§åˆ¶é … -->
            <div id="leverage-adjustment-controls" class="mt-3" style="display:none;">
                <div class="form-group">
                    <div class="row">
                        <div class="col-12">
                            <label for="leverage-slider" class="form-label">
                                <strong>èª¿æ•´æ§“æ¡¿å€æ•¸:</strong>
                                <span id="current-leverage-display" class="badge badge-primary">20x</span>
                            </label>
                        </div>
                    </div>

                    <!-- æ‹‰æ¡¿æ§åˆ¶å™¨ -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="leverage-slider-container">
                                <input type="range"
                                       class="form-control-range leverage-slider"
                                       id="leverage-slider"
                                       min="1"
                                       max="125"
                                       step="1"
                                       value="20">

                                <!-- æ‹‰æ¡¿åˆ»åº¦æ¨™è¨˜ (å‹•æ…‹ç”Ÿæˆï¼Œç²¾ç¢ºå°é½Š) -->
                                <div class="slider-ticks" id="slider-ticks-container">
                                    <!-- åˆ»åº¦å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                                </div>
                            </div>

                            <!-- æ–°å¢ï¼šç¨ç«‹çš„æ§“æ¡¿èªªæ˜å®¹å™¨ -->
                            <div class="leverage-info-container" id="leverage-limits-info">
                                <small style="color: #6c757d;">è¼‰å…¥ä¸­...</small>
                            </div>
                        </div>
                    </div>

                    <!-- å³æ™‚æ§“æ¡¿åˆ†æé¡¯ç¤º -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div id="live-leverage-analysis" class="p-3 border rounded bg-light">
                                <h6>ğŸ“Š æ§“æ¡¿ <span id="live-leverage-value">20</span>x åˆ†æ:</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small>
                                            <strong><span id="live-long-symbol">-</span> æŒå€‰ä¸Šé™:</strong>
                                            <span id="live-long-limit" class="text-info">è¨ˆç®—ä¸­...</span>
                                            <span id="live-long-status">-</span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small>
                                            <strong><span id="live-short-symbol">-</span> æŒå€‰ä¸Šé™:</strong>
                                            <span id="live-short-limit" class="text-info">è¨ˆç®—ä¸­...</span>
                                            <span id="live-short-status">-</span>
                                        </small>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small>
                                            <strong>ä¿è­‰é‡‘éœ€æ±‚:</strong>
                                            <span id="live-margin-requirement" class="text-warning">è¨ˆç®—ä¸­...</span>
                                            <strong class="ml-3">å……è¶³æ€§:</strong>
                                            <span id="live-overall-status">è¨ˆç®—ä¸­...</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¢ºèªæ§åˆ¶é … -->
                    <div class="form-group mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="leverage-confirm-checkbox">
                            <label class="form-check-label" for="leverage-confirm-checkbox">
                                æˆ‘äº†è§£æ§“æ¡¿èª¿æ•´çš„é¢¨éšªä¸¦ç¢ºèªåŸ·è¡Œ
                            </label>
                        </div>
                        <small class="text-muted form-text">èª¿æ•´å°‡åŒæ™‚å½±éŸ¿é•·å€‰å’Œç©ºå€‰çš„æ§“æ¡¿è¨­å®š</small>
                    </div>
                </div>
            </div>

            <div class="mt-2">
                <small class="text-muted">
                    âš ï¸ æ­¤ç‚ºåˆ†æå»ºè­°ï¼Œå¯¦éš›èª¿æ•´è«‹è‡ªè¡Œæ±ºå®š<br>
                    ğŸ’¡ æ§“æ¡¿èª¿æ•´ä¸å½±éŸ¿é¢¨éšªæ§åˆ¶é‚è¼¯ï¼Œé¢¨éšªä»ç”±åœæä½ç½®æ§ç®¡
                </small>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ•å€åŸŸ (ç§»åˆ°æ§“æ¡¿åˆ†æå¾Œæ–¹ï¼Œç¬¦åˆç”¨æˆ¶æ“ä½œç¿’æ…£) -->
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary mr-2" onclick="submitAdjust()">æ›´æ–°è³‡æ–™</button>
            <button type="button" class="btn btn-primary mr-2" onclick="closeOrder()">æ‰‹å‹•å¹³å€‰</button>
            <button type="button" class="btn btn-secondary" onclick="cancelAdjust()">å–æ¶ˆæ›´æ–°</button>
        </div>

        <br/>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('click', (event) => {
            const tags = ['INPUT', 'TEXTAREA']
            const focused = document.activeElement
            // console.log(focused.tagName)

            if (focused && focused !== event.target && tags.includes(focused.tagName)) {
                focused.blur()
            }
        })
        
        const telegram = Telegram.WebApp;
        telegram.ready();
        let id = '';
        let long = '';
        let short = '';
        let RPercent = 0;
        function initForm() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            RPercent = urlParams.get('RPercent');
            document.getElementById('RPercent').innerHTML = '1Rå¹¾%:' + RPercent + '%';
            document.getElementById('orderId').innerHTML = urlParams.get('id');
            id = urlParams.get('id');
            document.getElementById('long').innerHTML = 'ä½œå¤š:' + urlParams.get('long');
            long = urlParams.get('long');
            document.getElementById('short').innerHTML = 'ä½œç©º:' + urlParams.get('short');
            short = urlParams.get('short');
            document.getElementById('SL').value = Number(Math.abs(urlParams.get('sl')/RPercent).toFixed(3));
            if(urlParams.get('sl') < 0) {
                document.getElementById('isSLMinus').value = 'SL_Minus';
            } else {
                document.getElementById('isSLMinus').value = 'SL_Plus';
            }
            document.getElementById('TP').value = Number((urlParams.get('tp')/RPercent).toFixed(3));
            document.getElementById('preservePercent').value = Number((urlParams.get('preservePercent')/RPercent).toFixed(3));
            document.getElementById('savePercent').value = Number((urlParams.get('savePercent')/RPercent).toFixed(3));
            document.getElementById('trailingCondition').value = Number((urlParams.get('trailingCondition')/RPercent).toFixed(3));
            document.getElementById('trailingAmount').value = Number((urlParams.get('trailingAmount')/RPercent).toFixed(3));
            // åˆ¤æ–·ç•¶å‰çš„ä¿æœ¬/ç§»å‹•åœææ¨¡å¼
            const hasPreserve = urlParams.get('preservePercent') != 0 && urlParams.get('savePercent') != 0;
            const hasTrailing = urlParams.get('trailingCondition') != 0 && urlParams.get('trailingAmount') != 0;
            
            if (hasPreserve && hasTrailing) {
                document.getElementById('preserveType').value = 'preserve_trailing';
            } else if (hasPreserve) {
                document.getElementById('preserveType').value = 'preserve';
            } else if (hasTrailing) {
                document.getElementById('preserveType').value = 'trailing';
            } else {
                document.getElementById('preserveType').value = 'none';
            }
            toggleInputs();

            // æ§“æ¡¿åˆ†æåƒæ•¸è§£æ
            initLeverageAnalysis(urlParams);
        }

        function initLeverageAnalysis(urlParams) {
            // è§£ææ§“æ¡¿åˆ†æç›¸é—œåƒæ•¸
            const leverage = urlParams.get('leverage');
            const needsLeverageAdjustment = urlParams.get('needsLeverageAdjustment') === 'true';
            const suggestedLeverage = urlParams.get('suggestedLeverage');
            const maxExpectedNotional = urlParams.get('maxExpectedNotional');
            const currentMargin = urlParams.get('currentMargin');
            const maxMargin = urlParams.get('maxMargin');
            const longSufficient = urlParams.get('longSufficient') === 'true';
            const shortSufficient = urlParams.get('shortSufficient') === 'true';

            // è§£ææ–°å¢çš„æ§“æ¡¿åˆ†æåƒæ•¸
            const scalingMultiplier = urlParams.get('scalingMultiplier') || '5';
            const longLimit = parseFloat(urlParams.get('longLimit')) || 0;
            const shortLimit = parseFloat(urlParams.get('shortLimit')) || 0;
            const longSymbol = urlParams.get('longSymbol') || '-';
            const shortSymbol = urlParams.get('shortSymbol') || '-';

            // è§£æå¸³æˆ¶é¤˜é¡åƒæ•¸ (ç”¨æ–¼ä¿è­‰é‡‘å……è¶³æ€§æª¢æŸ¥)
            const accountBalance = parseFloat(urlParams.get('accountBalance')) || 0;
            console.log(`[ACCOUNT-BALANCE] æ¥æ”¶åˆ°å¸³æˆ¶é¤˜é¡: $${accountBalance.toFixed(2)}`);

            // è§£æçœŸå¯¦çš„ Binance æ§“æ¡¿æ•¸æ“š
            const leverageDataParam = urlParams.get('leverageData');
            if (leverageDataParam) {
                try {
                    realLeverageData = JSON.parse(decodeURIComponent(leverageDataParam));
                    console.log('[LEVERAGE-INIT] æˆåŠŸè¼‰å…¥çœŸå¯¦ Binance æ§“æ¡¿æ•¸æ“š:', realLeverageData);
                } catch (e) {
                    console.error('[LEVERAGE-INIT] è§£ææ§“æ¡¿æ•¸æ“šå¤±æ•—:', e);
                    realLeverageData = null;
                }
            }

            // æ›´æ–°æ§“æ¡¿åˆ†æé¡¯ç¤ºå€åŸŸ
            if (leverage) {
                const analysisSection = document.getElementById('leverage-analysis');
                analysisSection.style.display = 'block';

                // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                const longNotional = parseFloat(urlParams.get('longNotional')) || 0;
                const shortNotional = parseFloat(urlParams.get('shortNotional')) || 0;

                // æ›´æ–°åŸºæœ¬ä¿¡æ¯åˆ°å°æ‡‰çš„HTMLå…ƒç´ 
                document.getElementById('current-leverage-text').textContent = leverage;
                document.getElementById('long-notional').textContent = `$${longNotional.toFixed(2)}`;
                document.getElementById('short-notional').textContent = `$${shortNotional.toFixed(2)}`;
                document.getElementById('avg-notional').textContent = `$${((longNotional + shortNotional) / 2).toFixed(2)}`;
                document.getElementById('max-expected').textContent = `$${parseFloat(maxExpectedNotional || 0).toFixed(2)}`;
                document.getElementById('current-margin').textContent = `$${parseFloat(currentMargin || 0).toFixed(2)}`;
                document.getElementById('max-margin').textContent = `$${parseFloat(maxMargin || 0).toFixed(2)}`;
                document.getElementById('margin-increase').textContent = `$${(parseFloat(maxMargin || 0) - parseFloat(currentMargin || 0)).toFixed(2)}`;

                // æ›´æ–°æ–°å¢çš„æ§“æ¡¿åˆ†æé¡¯ç¤ºå…ƒç´ 
                if (document.getElementById('scaling-multiplier')) {
                    document.getElementById('scaling-multiplier').textContent = scalingMultiplier;
                }

                // ä¿®å¾©ï¼šé‡æ–°è¨ˆç®—æ­£ç¢ºçš„æŒå€‰ä¸Šé™ï¼Œä¸ä¾è³´ URL åƒæ•¸
                const recalcLongLimit = calculatePositionLimit(longSymbol, parseInt(leverage));
                const recalcShortLimit = calculatePositionLimit(shortSymbol, parseInt(leverage));

                console.log(`[INIT-LIMITS] URL åƒæ•¸: longLimit=${longLimit}, shortLimit=${shortLimit}`);
                console.log(`[INIT-LIMITS] é‡æ–°è¨ˆç®—: longLimit=${recalcLongLimit}, shortLimit=${recalcShortLimit}`);

                if (document.getElementById('long-limit')) {
                    const displayLongLimit = recalcLongLimit > 0 ? recalcLongLimit : longLimit;
                    const longLimitDisplay = displayLongLimit > 0 ? `$${displayLongLimit.toLocaleString()}` : 'è¨ˆç®—ä¸­...';
                    document.getElementById('long-limit').textContent = longLimitDisplay;
                }
                if (document.getElementById('short-limit')) {
                    const displayShortLimit = recalcShortLimit > 0 ? recalcShortLimit : shortLimit;
                    const shortLimitDisplay = displayShortLimit > 0 ? `$${displayShortLimit.toLocaleString()}` : 'è¨ˆç®—ä¸­...';
                    document.getElementById('short-limit').textContent = shortLimitDisplay;
                }

                if (document.getElementById('long-symbol-text')) {
                    document.getElementById('long-symbol-text').textContent = longSymbol;
                }
                if (document.getElementById('short-symbol-text')) {
                    document.getElementById('short-symbol-text').textContent = shortSymbol;
                }

                // ä¿®å¾©ï¼šé‡æ–°è¨ˆç®—å……è¶³æ€§ï¼Œä½¿ç”¨é‡æ–°è¨ˆç®—çš„æŒå€‰ä¸Šé™
                const maxExpected = parseFloat(maxExpectedNotional) || 0;
                let recalcLongSufficient = false;
                let recalcShortSufficient = false;

                const finalLongLimit = recalcLongLimit > 0 ? recalcLongLimit : longLimit;
                const finalShortLimit = recalcShortLimit > 0 ? recalcShortLimit : shortLimit;

                if (finalLongLimit > 0 && maxExpected > 0) {
                    recalcLongSufficient = maxExpected <= finalLongLimit;
                }
                if (finalShortLimit > 0 && maxExpected > 0) {
                    recalcShortSufficient = maxExpected <= finalShortLimit;
                }

                console.log(`[INIT-SUFFICIENCY] é‡æ–°è¨ˆç®—å……è¶³æ€§: finalLongLimit=${finalLongLimit}, finalShortLimit=${finalShortLimit}, maxExpected=${maxExpected}`);
                console.log(`[INIT-SUFFICIENCY] é•·å€‰å……è¶³æ€§: ${recalcLongSufficient} (${maxExpected} <= ${finalLongLimit})`);
                console.log(`[INIT-SUFFICIENCY] ç©ºå€‰å……è¶³æ€§: ${recalcShortSufficient} (${maxExpected} <= ${finalShortLimit})`);

                if (document.getElementById('long-sufficient')) {
                    // ä½¿ç”¨é‡æ–°è¨ˆç®—çš„å……è¶³æ€§
                    if (finalLongLimit > 0 && maxExpected > 0) {
                        document.getElementById('long-sufficient').innerHTML = `${recalcLongSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}`;
                    } else {
                        document.getElementById('long-sufficient').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
                    }
                }

                if (document.getElementById('short-sufficient')) {
                    if (finalShortLimit > 0 && maxExpected > 0) {
                        document.getElementById('short-sufficient').innerHTML = `${recalcShortSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}`;
                    } else {
                        document.getElementById('short-sufficient').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
                    }
                }

                // ä¿®å¾©ï¼šæ›´æ–° leverage-info å€åŸŸï¼ˆé¡¯ç¤ºå½™ç¸½ä¿¡æ¯ï¼‰
                const hasValidData = finalLongLimit > 0 && finalShortLimit > 0;

                // è¨ˆç®—ä¿è­‰é‡‘å……è¶³æ€§
                const maxExpectedForMargin = parseFloat(maxExpectedNotional) || 0;
                const marginRequirement = maxExpectedForMargin > 0 ? (maxExpectedForMargin * 2) / parseInt(leverage) : 0;
                const marginSufficient = accountBalance > 0 && marginRequirement > 0 ? accountBalance >= marginRequirement : false;

                console.log(`[INIT-MARGIN] ä¿è­‰é‡‘è¨ˆç®—: éœ€æ±‚ $${marginRequirement.toFixed(2)}, é¤˜é¡ $${accountBalance.toFixed(2)}, å……è¶³ ${marginSufficient}`);

                // ä¿®å¾©ï¼šä½¿ç”¨é‡æ–°è¨ˆç®—çš„å……è¶³æ€§çµæœï¼ˆåŸºæ–¼åŸå§‹è¨‚å–®æ§“æ¡¿ï¼‰
                const overallSufficient = hasValidData ? (recalcLongSufficient && recalcShortSufficient && marginSufficient) : null;

                document.getElementById('leverage-info').innerHTML = `
                    <div class="row">
                        <div class="col-sm-6"><strong>ç›®å‰æ§“æ¡¿:</strong> ${leverage}x</div>
                        <div class="col-sm-6"><strong>ç¸½é«”ç‹€æ…‹:</strong> ${
                            overallSufficient === null ? '<span style="color:gray">è¨ˆç®—ä¸­...</span>' :
                            overallSufficient ? '<span style="color:green">âœ… ä¿è­‰é‡‘èˆ‡æ§“æ¡¿å……è¶³</span>' : '<span style="color:orange">âš ï¸ éœ€å¢åŠ ä¿è­‰é‡‘æˆ–èª¿æ•´æ§“æ¡¿</span>'
                        }</div>
                    </div>
                `;

                // ä¿®å¾©ï¼šæ›´æ–° position-sufficiency å€åŸŸï¼ˆè©³ç´°æŒå€‰åˆ†æï¼‰
                document.getElementById('position-sufficiency').innerHTML = `
                    <div class="row">
                        <div class="col-sm-6">
                            <small><strong>é•·å€‰å……è¶³æ€§:</strong> ${
                                !hasValidData ? '<span style="color:gray">è¨ˆç®—ä¸­...</span>' :
                                recalcLongSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'
                            }</small>
                        </div>
                        <div class="col-sm-6">
                            <small><strong>ç©ºå€‰å……è¶³æ€§:</strong> ${
                                !hasValidData ? '<span style="color:gray">è¨ˆç®—ä¸­...</span>' :
                                recalcShortSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'
                            }</small>
                        </div>
                    </div>
                `;

                // æ›´æ–°å»ºè­°èˆ‡æ§åˆ¶
                const recommendationDiv = document.getElementById('leverage-recommendation');
                const adjustmentControlsDiv = document.getElementById('leverage-adjustment-controls');

                // æ ¹æ“šæ˜¯å¦æœ‰å»ºè­°é¡¯ç¤ºä¸åŒçš„å»ºè­°æ–‡å­—
                if (needsLeverageAdjustment && suggestedLeverage) {
                    recommendationDiv.innerHTML = `
                        <div class="recommendation-warning">
                            âš ï¸ ç³»çµ±å»ºè­°èª¿æ•´æ§“æ¡¿è‡³: ${suggestedLeverage}x
                        </div>
                    `;
                } else {
                    recommendationDiv.innerHTML = `
                        <div class="recommendation-ok">
                            âœ… ç›®å‰æ§“æ¡¿å……è¶³ï¼Œç„¡éœ€èª¿æ•´
                            <br><small>ğŸ”§ æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•èª¿æ•´æ§“æ¡¿ (å¯é¸)</small>
                        </div>
                    `;
                }

                // å§‹çµ‚é¡¯ç¤ºèª¿æ•´æ§åˆ¶é …ï¼Œè®“ç”¨æˆ¶éš¨æ™‚å¯ä»¥èª¿æ•´
                adjustmentControlsDiv.style.display = 'block';

                // åˆå§‹åŒ–æ‹‰æ¡¿å¼æ§“æ¡¿èª¿æ•´
                initLeverageSlider(leverage, suggestedLeverage, needsLeverageAdjustment, longSymbol, shortSymbol, parseFloat(maxExpectedNotional), accountBalance);
            } else {
                // å¦‚æœæ²’æœ‰æ§“æ¡¿åˆ†ææ•¸æ“šï¼Œéš±è—æ•´å€‹å€åŸŸ
                document.getElementById('leverage-analysis').style.display = 'none';
            }
        }

        // å…¨åŸŸè®Šæ•¸å„²å­˜æ§“æ¡¿åˆ†æç›¸é—œæ•¸æ“š
        let globalLeverageData = {
            longSymbol: '',
            shortSymbol: '',
            maxExpectedNotional: 0,
            currentLeverage: 20,
            suggestedLeverage: 20,
            accountBalance: 0
        };

        function initLeverageSlider(currentLeverage, suggestedLeverage, needsAdjustment, longSymbol, shortSymbol, maxExpectedNotional, accountBalance) {
            // å„²å­˜å…¨åŸŸæ•¸æ“š
            globalLeverageData = {
                longSymbol: longSymbol,
                shortSymbol: shortSymbol,
                maxExpectedNotional: maxExpectedNotional,
                currentLeverage: parseInt(currentLeverage),
                suggestedLeverage: parseInt(suggestedLeverage),
                accountBalance: accountBalance || 0
            };

            const leverageSlider = document.getElementById('leverage-slider');
            const currentLeverageDisplay = document.getElementById('current-leverage-display');
            const liveLeverageValue = document.getElementById('live-leverage-value');

            // è¨ˆç®—äº¤æ˜“å°çš„æœ€å¤§æ§“æ¡¿é™åˆ¶
            const maxLeverageData = getMaxLeverageForSymbols(longSymbol, shortSymbol);
            const actualMaxLeverage = maxLeverageData.max;

            // å‹•æ…‹è¨­å®šæ‹‰æ¡¿æœ€å¤§å€¼
            leverageSlider.min = 1;
            leverageSlider.max = actualMaxLeverage;
            leverageSlider.value = Math.min(parseInt(currentLeverage), actualMaxLeverage);

            // æ›´æ–°é¡¯ç¤º
            currentLeverageDisplay.textContent = leverageSlider.value + 'x';
            liveLeverageValue.textContent = leverageSlider.value;

            // å‹•æ…‹ç”Ÿæˆåˆ»åº¦æ¨™è¨˜
            generateSliderTicks(actualMaxLeverage, maxLeverageData);

            // åˆå§‹åŒ–å³æ™‚åˆ†æå€åŸŸ
            updateLiveLeverageAnalysis(parseInt(leverageSlider.value));

            // æ·»åŠ æ‹‰æ¡¿äº‹ä»¶ç›£è½å™¨
            leverageSlider.addEventListener('input', function(e) {
                const newLeverage = parseInt(e.target.value);
                currentLeverageDisplay.textContent = newLeverage + 'x';
                liveLeverageValue.textContent = newLeverage;

                // æ›´æ–°åˆ»åº¦æ¨™è¨˜
                updateSliderTicks(newLeverage);

                // å³æ™‚æ›´æ–°æ§“æ¡¿åˆ†æ
                updateLiveLeverageAnalysis(newLeverage);
            });

            // åˆå§‹åŒ–åˆ»åº¦æ¨™è¨˜é»æ“Šäº‹ä»¶
            initSliderTicks();

            // æ›´æ–°åˆ»åº¦æ¨™è¨˜
            updateSliderTicks(parseInt(leverageSlider.value));

            console.log(`[LEVERAGE-SLIDER] åˆå§‹åŒ–å®Œæˆ: ${longSymbol}(æœ€å¤§${maxLeverageData.long}x) ${shortSymbol}(æœ€å¤§${maxLeverageData.short}x) å¯¦éš›ä¸Šé™${actualMaxLeverage}x`);
        }

        function getMaxLeverageForSymbols(longSymbol, shortSymbol) {
            let longMax = 125, shortMax = 125;

            // ä¿®å¾©ï¼šä½¿ç”¨æ–°çš„æ•¸æ“šçµæ§‹æª¢æ¸¬æœ€å¤§æ§“æ¡¿
            if (realLeverageData && realLeverageData.brackets) {
                if (realLeverageData.brackets[longSymbol] && realLeverageData.brackets[longSymbol].length > 0) {
                    const longBrackets = realLeverageData.brackets[longSymbol];
                    longMax = Math.max(...longBrackets.map(b => b.leverage));
                }
                if (realLeverageData.brackets[shortSymbol] && realLeverageData.brackets[shortSymbol].length > 0) {
                    const shortBrackets = realLeverageData.brackets[shortSymbol];
                    shortMax = Math.max(...shortBrackets.map(b => b.leverage));
                }
                console.log(`[LEVERAGE-MAX] ä½¿ç”¨çœŸå¯¦æ•¸æ“š: ${longSymbol}=${longMax}x, ${shortSymbol}=${shortMax}x`);
            } else {
                // å‚™ç”¨ï¼šå·²çŸ¥çš„äº¤æ˜“å°æœ€å¤§æ§“æ¡¿é™åˆ¶
                const knownLimits = {
                    'DEXEUSDT': 50,
                    'DOGEUSDT': 75,
                    'BTCUSDT': 125,
                    'ETHUSDT': 125
                };
                longMax = knownLimits[longSymbol] || 125;
                shortMax = knownLimits[shortSymbol] || 125;
                console.log(`[LEVERAGE-MAX] ä½¿ç”¨å‚™ç”¨æ•¸æ“š: ${longSymbol}=${longMax}x, ${shortSymbol}=${shortMax}x`);
            }

            return {
                long: longMax,
                short: shortMax,
                max: Math.min(longMax, shortMax) // å–è¼ƒå°çš„ä½œç‚ºå¯¦éš›ä¸Šé™
            };
        }

        function generateSliderTicks(maxLeverage, leverageData) {
            const container = document.getElementById('slider-ticks-container');
            container.innerHTML = '';

            // æ™ºèƒ½ç”Ÿæˆåˆ»åº¦å€¼ï¼Œé¿å…é‡ç–Š
            let tickValues = [1];
            const minSpacing = 15; // æœ€å°é–“è· (%)

            // æ ¹æ“šæœ€å¤§æ§“æ¡¿å‹•æ…‹èª¿æ•´åˆ»åº¦
            if (maxLeverage <= 10) {
                tickValues = [1, 5, 10].filter(v => v <= maxLeverage);
            } else if (maxLeverage <= 25) {
                tickValues = [1, 5, 10, 20, 25].filter(v => v <= maxLeverage);
            } else if (maxLeverage <= 50) {
                tickValues = [1, 10, 20, 50].filter(v => v <= maxLeverage);
            } else if (maxLeverage <= 100) {
                tickValues = [1, 20, 50, 75, 100].filter(v => v <= maxLeverage);
            } else {
                tickValues = [1, 25, 50, 100, 125].filter(v => v <= maxLeverage);
            }

            // ç¢ºä¿æœ€å¤§æ§“æ¡¿å€¼åœ¨åˆ»åº¦ä¸­
            if (!tickValues.includes(maxLeverage)) {
                tickValues.push(maxLeverage);
                tickValues.sort((a, b) => a - b);
            }

            // æª¢æŸ¥ä¸¦ç§»é™¤éæ–¼æ¥è¿‘çš„åˆ»åº¦
            const filteredTicks = [tickValues[0]]; // ä¿ç•™ç¬¬ä¸€å€‹
            for (let i = 1; i < tickValues.length; i++) {
                const currentPos = ((tickValues[i] - 1) / (maxLeverage - 1)) * 100;
                const lastPos = ((filteredTicks[filteredTicks.length - 1] - 1) / (maxLeverage - 1)) * 100;

                if (Math.abs(currentPos - lastPos) >= minSpacing || tickValues[i] === maxLeverage) {
                    filteredTicks.push(tickValues[i]);
                }
            }

            // ç”Ÿæˆåˆ»åº¦æ¨™è¨˜
            filteredTicks.forEach(value => {
                const tick = document.createElement('span');
                tick.className = 'tick';
                tick.setAttribute('data-value', value);
                tick.textContent = value + 'x';

                // è¨ˆç®—ç²¾ç¢ºçš„ä½ç½® (ç·šæ€§åˆ†ä½ˆ)
                const position = ((value - 1) / (maxLeverage - 1)) * 100;
                tick.style.left = Math.max(0, Math.min(100, position)) + '%';
                tick.style.position = 'absolute';
                tick.style.transform = 'translateX(-50%)';

                // ç‰¹æ®Šæ¨™è¨˜
                if (value === maxLeverage) {
                    tick.classList.add('max-leverage');
                    tick.style.color = '#dc3545';
                    tick.style.fontWeight = 'bold';
                    tick.style.zIndex = '20';
                }

                // é»æ“Šäº‹ä»¶
                tick.addEventListener('click', () => {
                    document.getElementById('leverageSlider').value = value;
                    updateLiveLeverageAnalysis(value);
                });

                container.appendChild(tick);
            });

            // ä¿®å¾©ï¼šå°‡èªªæ˜æ–‡å­—ç§»åˆ°ç¨ç«‹å®¹å™¨ï¼Œä¸æ·»åŠ åˆ°åˆ»åº¦å®¹å™¨ä¸­
            const leverageLimitsInfo = document.getElementById('leverage-limits-info');
            if (leverageLimitsInfo) {
                leverageLimitsInfo.innerHTML = `<small style="color: #6c757d;">
                    ${leverageData.long !== leverageData.short ?
                        `${globalLeverageData.longSymbol}: æœ€å¤§${leverageData.long}x, ${globalLeverageData.shortSymbol}: æœ€å¤§${leverageData.short}x` :
                        `æœ€å¤§æ§“æ¡¿: ${maxLeverage}x`}
                </small>`;
            }
        }

        function initSliderTicks() {
            const ticks = document.querySelectorAll('.tick');
            ticks.forEach(tick => {
                tick.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    const leverageSlider = document.getElementById('leverage-slider');
                    leverageSlider.value = value;

                    // è§¸ç™¼ input äº‹ä»¶
                    leverageSlider.dispatchEvent(new Event('input'));
                });
            });
        }

        function updateSliderTicks(currentValue) {
            const ticks = document.querySelectorAll('.tick');
            ticks.forEach(tick => {
                const tickValue = parseInt(tick.getAttribute('data-value'));
                if (tickValue === currentValue) {
                    tick.classList.add('active');
                } else {
                    tick.classList.remove('active');
                }
            });
        }

        function updateLiveLeverageAnalysis(leverage) {
            // è¨ˆç®—è©²æ§“æ¡¿ä¸‹çš„æŒå€‰ä¸Šé™
            const longLimit = calculatePositionLimit(globalLeverageData.longSymbol, leverage);
            const shortLimit = calculatePositionLimit(globalLeverageData.shortSymbol, leverage);

            // ä¿®å¾©ï¼šç¢ºä¿æœ‰æœ‰æ•ˆçš„æ•¸æ“šæ‰é€²è¡Œå……è¶³æ€§è¨ˆç®—
            const maxExpected = globalLeverageData.maxExpectedNotional || 0;
            const hasValidData = longLimit > 0 && shortLimit > 0 && maxExpected > 0;

            let longSufficient = false;
            let shortSufficient = false;
            let overallSufficient = false;

            // è¨ˆç®—ä¿è­‰é‡‘éœ€æ±‚
            const marginRequirement = maxExpected > 0 ? (maxExpected * 2) / leverage : 0;

            // ä¿®å¾©ï¼šåŸºæ–¼ä¿è­‰é‡‘éœ€æ±‚ vs å¸³æˆ¶é¤˜é¡çš„å……è¶³æ€§æª¢æŸ¥
            const accountBalance = globalLeverageData.accountBalance || 0;
            const marginSufficient = marginRequirement > 0 && accountBalance > 0 ? accountBalance >= marginRequirement : false;

            if (hasValidData) {
                longSufficient = maxExpected <= longLimit;
                shortSufficient = maxExpected <= shortLimit;
                overallSufficient = longSufficient && shortSufficient && marginSufficient;
                console.log(`[LIVE-ANALYSIS] ${leverage}x: é•·å€‰ ${longSufficient ? 'âœ…' : 'âŒ'} (${maxExpected} <= ${longLimit}), ç©ºå€‰ ${shortSufficient ? 'âœ…' : 'âŒ'} (${maxExpected} <= ${shortLimit}), ä¿è­‰é‡‘ ${marginSufficient ? 'âœ…' : 'âŒ'}`);
            } else {
                console.log(`[LIVE-ANALYSIS] ${leverage}x: æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•è¨ˆç®—å……è¶³æ€§ (longLimit=${longLimit}, shortLimit=${shortLimit}, maxExpected=${maxExpected})`);
            }

            console.log(`[MARGIN-CHECK] ${leverage}x: ä¿è­‰é‡‘éœ€æ±‚ ${marginRequirement.toFixed(2)} vs å¸³æˆ¶é¤˜é¡ ${accountBalance.toFixed(2)} = ${marginSufficient ? 'å……è¶³' : 'ä¸è¶³'}`);

            // ä¿®å¾©ï¼šæ›´æ–°é¡¯ç¤ºé‚è¼¯ï¼Œæ ¹æ“šæ•¸æ“šæœ‰æ•ˆæ€§é¡¯ç¤ºä¸åŒç‹€æ…‹
            document.getElementById('live-long-symbol').textContent = globalLeverageData.longSymbol || '-';
            document.getElementById('live-short-symbol').textContent = globalLeverageData.shortSymbol || '-';
            document.getElementById('live-long-limit').textContent = longLimit > 0 ? `$${longLimit.toLocaleString()}` : 'è¨ˆç®—ä¸­...';
            document.getElementById('live-short-limit').textContent = shortLimit > 0 ? `$${shortLimit.toLocaleString()}` : 'è¨ˆç®—ä¸­...';

            // ä¿®å¾©ï¼šåªæœ‰åœ¨æœ‰æœ‰æ•ˆæ•¸æ“šæ™‚æ‰é¡¯ç¤ºå……è¶³æ€§ç‹€æ…‹
            if (hasValidData) {
                document.getElementById('live-long-status').innerHTML = longSufficient ? '<span style="color:green">âœ…</span>' : '<span style="color:red">âŒ</span>';
                document.getElementById('live-short-status').innerHTML = shortSufficient ? '<span style="color:green">âœ…</span>' : '<span style="color:red">âŒ</span>';

                // ä¿®å¾©ï¼šç¸½é«”å……è¶³æ€§åŸºæ–¼æ§“æ¡¿å……è¶³æ€§å’Œä¿è­‰é‡‘å……è¶³æ€§
                if (marginRequirement > 0 && accountBalance > 0) {
                    document.getElementById('live-overall-status').innerHTML = overallSufficient ?
                        '<span style="color:green">âœ… ä¿è­‰é‡‘èˆ‡æ§“æ¡¿å……è¶³</span>' : '<span style="color:red">âŒ éœ€å¢åŠ ä¿è­‰é‡‘æˆ–èª¿æ•´æ§“æ¡¿</span>';
                } else {
                    document.getElementById('live-overall-status').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
                }
            } else {
                document.getElementById('live-long-status').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
                document.getElementById('live-short-status').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
                document.getElementById('live-overall-status').innerHTML = '<span style="color:gray">è¨ˆç®—ä¸­...</span>';
            }

            document.getElementById('live-margin-requirement').textContent = marginRequirement > 0 ? `$${marginRequirement.toFixed(2)}` : 'è¨ˆç®—ä¸­...';

            // ä¿®å¾©ï¼šæ›´æ–°åˆ†ææ¡†æ¶çš„æ¨£å¼ï¼ŒåŸºæ–¼ç¸½é«”å……è¶³æ€§
            const analysisBox = document.getElementById('live-leverage-analysis');
            analysisBox.className = 'p-3 border rounded bg-light';
            if (!hasValidData) {
                // æ•¸æ“šä¸è¶³æ™‚çš„æ¨£å¼
            } else if (overallSufficient) {
                analysisBox.classList.add('sufficient');
            } else {
                analysisBox.classList.add('danger');
            }
        }

        // å…¨åŸŸè®Šæ•¸å„²å­˜ Binance çœŸå¯¦æ§“æ¡¿æ•¸æ“š
        let realLeverageData = null;

        function calculatePositionLimit(symbol, leverage) {
            // ä¿®å¾©ï¼šä½¿ç”¨æ–°çš„ Binance API æ•¸æ“šçµæ§‹
            if (realLeverageData && realLeverageData.brackets && realLeverageData.brackets[symbol]) {
                const brackets = realLeverageData.brackets[symbol];

                // ä½¿ç”¨æ­£ç¢ºçš„å€é–“é‚è¼¯ (æ‰¾åˆ°ç¬¬ä¸€å€‹èƒ½è¦†è“‹è©²æ§“æ¡¿çš„ç´šåˆ¥)
                for (const bracket of brackets) {
                    if (leverage <= bracket.leverage) {
                        console.log(`[LEVERAGE-CALC] ${symbol} ${leverage}x ä½¿ç”¨çœŸå¯¦æ•¸æ“š (å€é–“ ${bracket.leverage}x): $${bracket.limit.toLocaleString()}`);
                        return bracket.limit;
                    }
                }

                // å¦‚æœè¶…éæ‰€æœ‰ç´šåˆ¥ï¼Œä½¿ç”¨æœ€å¾Œä¸€å€‹ç´šåˆ¥
                if (brackets.length > 0) {
                    const lastBracket = brackets[brackets.length - 1];
                    console.log(`[LEVERAGE-CALC] ${symbol} ${leverage}x è¶…éæœ€å¤§ç´šåˆ¥ï¼Œä½¿ç”¨ ${lastBracket.leverage}x: $${lastBracket.limit.toLocaleString()}`);
                    return lastBracket.limit;
                }
            }

            // å‚™ç”¨ï¼šä¿®æ­£çš„æŒå€‰ä¸Šé™è¨ˆç®— (ä¿®å¾© DEXE å’Œ DOGE çš„æ­£ç¢ºæ•¸å€¼)
            console.log(`[LEVERAGE-CALC] ${symbol} ${leverage}x ä½¿ç”¨å‚™ç”¨æ•¸æ“š`);
            const leverageLimits = {
                'BTCUSDT': {1: 10000000, 5: 5000000, 10: 1000000, 20: 500000, 50: 100000, 125: 50000},
                'ETHUSDT': {1: 5000000, 5: 2500000, 10: 500000, 20: 250000, 50: 50000, 125: 25000},
                'DEXEUSDT': {1: 500000, 5: 250000, 10: 100000, 20: 50000, 50: 5000, 125: 5000},
                'DOGEUSDT': {1: 10000000, 5: 5000000, 10: 2000000, 20: 1000000, 50: 150000, 75: 150000, 125: 150000},
                'default': {1: 1000000, 5: 500000, 10: 200000, 20: 100000, 50: 20000, 125: 10000}
            };

            const limits = leverageLimits[symbol] || leverageLimits['default'];

            // ä¿®å¾©ï¼šä½¿ç”¨æ­£ç¢ºçš„å€é–“é‚è¼¯
            const leverageLevels = Object.keys(limits).map(k => parseInt(k)).sort((a, b) => a - b);

            for (const lev of leverageLevels) {
                if (leverage <= lev) {
                    console.log(`[LEVERAGE-CALC] ${symbol} ${leverage}x ä½¿ç”¨å‚™ç”¨æ•¸æ“š (å€é–“ ${lev}x): $${limits[lev].toLocaleString()}`);
                    return limits[lev];
                }
            }

            // å¦‚æœè¶…éæ‰€æœ‰ç´šåˆ¥ï¼Œä½¿ç”¨æœ€å¾Œä¸€å€‹ç´šåˆ¥
            if (leverageLevels.length > 0) {
                const lastLevel = leverageLevels[leverageLevels.length - 1];
                console.log(`[LEVERAGE-CALC] ${symbol} ${leverage}x è¶…éæœ€å¤§ç´šåˆ¥ï¼Œä½¿ç”¨å‚™ç”¨ ${lastLevel}x: $${limits[lastLevel].toLocaleString()}`);
                return limits[lastLevel];
            }

            return 0;
        }

        function toggleInputs() {
            const type = document.getElementById('preserveType').value;
            document.getElementById('preserveInputs').style.display = 
                (type === 'preserve' || type === 'preserve_trailing') ? 'flex' : 'none';
            document.getElementById('trailingInputs').style.display = 
                (type === 'trailing' || type === 'preserve_trailing') ? 'flex' : 'none';
        }

        function submitAdjust() {
            var SL = document.getElementById('SL').value;
            const isSLMinus = document.getElementById('isSLMinus').value;
            let TP = document.getElementById('TP').value;
            let preservePercent = parseFloat(document.getElementById('preservePercent').value);
            let savePercent = parseFloat(document.getElementById('savePercent').value);
            let trailingCondition = parseFloat(document.getElementById('trailingCondition').value);
            let trailingAmount = parseFloat(document.getElementById('trailingAmount').value);
            const preserveType = document.getElementById('preserveType').value;

            // æ§“æ¡¿èª¿æ•´ç›¸é—œè®Šæ•¸
            let newLeverage = '';
            let isLeverageAdjustment = false;
            const leverageAnalysisSection = document.getElementById('leverage-analysis');
            const leverageCheckbox = document.getElementById('leverage-confirm-checkbox');
            const leverageSlider = document.getElementById('leverage-slider');

            // æª¢æŸ¥æ˜¯å¦æœ‰æ§“æ¡¿åˆ†æä¸”ç”¨æˆ¶é¸æ“‡è¦èª¿æ•´
            if (leverageAnalysisSection && leverageAnalysisSection.style.display !== 'none') {
                const adjustmentControls = document.getElementById('leverage-adjustment-controls');
                if (adjustmentControls && adjustmentControls.style.display !== 'none') {
                    // æª¢æŸ¥ç¢ºèªå‹¾é¸æ¡†
                    if (leverageCheckbox && leverageCheckbox.checked) {
                        if (leverageSlider && leverageSlider.value) {
                            newLeverage = leverageSlider.value;
                            isLeverageAdjustment = true;
                        } else {
                            alert('è«‹è¨­å®šæ–°çš„æ§“æ¡¿å€¼');
                            return;
                        }
                    }
                }
            }

            if (SL === '' || TP === '') {
                alert('è«‹è¼¸å…¥SL, TP');
                return;
            }

            if (isNaN(SL) || isNaN(TP)) {
                alert('SL, TP, å¿…é ˆç‚ºæ•¸å­—');
                return;
            }

            if (preserveType === 'preserve') {
                if (preservePercent === '') {
                    alert('è«‹è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶');
                    return;
                }
                if (savePercent === '') {
                    alert('è«‹è¼¸å…¥ä¿æœ¬Ræ•¸');
                    return;
                }
                if (isNaN(preservePercent) || isNaN(savePercent)) {
                    alert('è‡ªå‹•ä¿æœ¬æ¢ä»¶å’Œä¿æœ¬Ræ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (preservePercent <= 0 || savePercent <= 0) {
                    alert('è‡ªå‹•ä¿æœ¬æ¢ä»¶å’Œä¿æœ¬Ræ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
            } else if (preserveType === 'trailing') {
                if (trailingCondition === '') {
                    alert('è«‹è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶');
                    return;
                }
                if (trailingAmount === '') {
                    alert('è«‹è¼¸å…¥å›åç§»å‹•Ræ•¸');
                    return;
                }
                if (isNaN(trailingCondition) || isNaN(trailingAmount)) {
                    alert('ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶å’Œå›åç§»å‹•Ræ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (trailingCondition <= 0 || trailingAmount <= 0) {
                    alert('ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶å’Œå›åç§»å‹•Ræ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
            } else if (preserveType === 'preserve_trailing') {
                // ä¿æœ¬+ç§»å‹•åœææ¨¡å¼çš„é©—è­‰
                if (preservePercent === '') {
                    alert('è«‹è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶');
                    return;
                }
                if (savePercent === '') {
                    alert('è«‹è¼¸å…¥ä¿æœ¬Ræ•¸');
                    return;
                }
                if (trailingCondition === '') {
                    alert('è«‹è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶');
                    return;
                }
                if (trailingAmount === '') {
                    alert('è«‹è¼¸å…¥å›åç§»å‹•Ræ•¸');
                    return;
                }
                if (isNaN(preservePercent) || isNaN(savePercent) || isNaN(trailingCondition) || isNaN(trailingAmount)) {
                    alert('æ‰€æœ‰åƒæ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (preservePercent <= 0 || savePercent <= 0 || trailingCondition <= 0 || trailingAmount <= 0) {
                    alert('æ‰€æœ‰åƒæ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
                // é—œéµé©—è­‰ï¼šä¿æœ¬å•Ÿå‹•Ræ•¸ä¸å¯å¤§æ–¼ç­‰æ–¼ç§»å‹•åœæå•Ÿå‹•Ræ•¸
                if (parseFloat(preservePercent) >= parseFloat(trailingCondition)) {
                    alert('ä¿æœ¬å•Ÿå‹•Ræ•¸ä¸å¯å¤§æ–¼ç­‰æ–¼ç§»å‹•åœæå•Ÿå‹•Ræ•¸');
                    return;
                }
            }
            
            // æ ¹æ“šé¸æ“‡çš„æ¨¡å¼è¨­å®šåƒæ•¸
            if (preserveType === 'none') {
                preservePercent = 0;
                savePercent = 0;
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'preserve') {
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'trailing') {
                preservePercent = 0;
                savePercent = 0;
            }

            
            if (isSLMinus === 'SL_Minus') {
                SL = -SL;
            }
            const orig_SL = SL;
            const orig_TP = TP;
            const orig_preservePercent = preservePercent;
            const orig_savePercent = savePercent;
            const orig_trailingCondition = trailingCondition;
            const orig_trailingAmount = trailingAmount;

            SL = Number((SL * RPercent).toFixed(3));
            TP = Number(Math.abs(TP * RPercent).toFixed(3));
            if (preserveType === 'preserve') {
                preservePercent = Number(Math.abs(preservePercent * RPercent).toFixed(3));
                savePercent = Number(Math.abs(savePercent * RPercent).toFixed(3));
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'trailing') {
                trailingCondition = Number(Math.abs(trailingCondition * RPercent).toFixed(3));
                trailingAmount = Number(Math.abs(trailingAmount * RPercent).toFixed(3));
                preservePercent = 0;
                savePercent = 0;
            } else if (preserveType === 'preserve_trailing') {
                preservePercent = Number(Math.abs(preservePercent * RPercent).toFixed(3));
                savePercent = Number(Math.abs(savePercent * RPercent).toFixed(3));
                trailingCondition = Number(Math.abs(trailingCondition * RPercent).toFixed(3));
                trailingAmount = Number(Math.abs(trailingAmount * RPercent).toFixed(3));
            } else {
                preservePercent = 0;
                savePercent = 0;
                trailingCondition = 0;
                trailingAmount = 0;
            }
            
            var result = '';
            result = 'id=' + id + '&SL=' + SL + '&TP=' + TP + '&preservePercent=' + preservePercent + '&savePercent=' + savePercent + '&trailingCondition=' + trailingCondition + '&trailingAmount=' + trailingAmount + '&preserveType=' + preserveType;

            // æ·»åŠ æ§“æ¡¿èª¿æ•´åƒæ•¸
            if (isLeverageAdjustment) {
                result += '&newLeverage=' + newLeverage;
            }
            var checkResult = 'è«‹ç¢ºèªä¿®æ”¹åƒæ•¸:\nä½œå¤š:' + long + '\nä½œç©º:' + short + '\n1Rå¹¾%:'+ RPercent + '%\nSL:' + SL + '%('+ orig_SL + 'R)\nTP:' + TP + '%(' + orig_TP +'R)';
            if (preserveType === 'preserve') {
                checkResult += '\nè‡ªå‹•ä¿æœ¬æ¢ä»¶:' + preservePercent + '%(' + orig_preservePercent + 'R)\nä¿æœ¬Ræ•¸:' + savePercent + '%(' + orig_savePercent + 'R)';
            } else if (preserveType === 'trailing') {
                checkResult += '\nç§»å‹•åœææ¢ä»¶:' + trailingCondition + '%(' + orig_trailingCondition + 'R)\nå›åç§»å‹•Ræ•¸:' + trailingAmount + '%(' + orig_trailingAmount + 'R)';
            } else if (preserveType === 'preserve_trailing') {
                checkResult += '\nä¿æœ¬+ç§»å‹•åœææ¨¡å¼\nè‡ªå‹•ä¿æœ¬æ¢ä»¶:' + preservePercent + '%(' + orig_preservePercent + 'R)\nä¿æœ¬Ræ•¸:' + savePercent + '%(' + orig_savePercent + 'R)\nç§»å‹•åœææ¢ä»¶:' + trailingCondition + '%(' + orig_trailingCondition + 'R)\nå›åç§»å‹•Ræ•¸:' + trailingAmount + '%(' + orig_trailingAmount + 'R)';
            } else {
                checkResult += '\nä¸å•Ÿç”¨ä¿æœ¬/ç§»å‹•åœæ';
            }

            // æ·»åŠ æ§“æ¡¿èª¿æ•´ç¢ºèªä¿¡æ¯
            if (isLeverageAdjustment) {
                checkResult += '\n\nğŸ”§ æ§“æ¡¿èª¿æ•´:\næ–°æ§“æ¡¿: ' + newLeverage + 'x';
                checkResult += '\nâš ï¸ æ³¨æ„: èª¿æ•´æ§“æ¡¿æœƒåŒæ™‚å½±éŸ¿é•·å€‰å’Œç©ºå€‰';
            }

            telegram.showConfirm(checkResult, function(isOK){
                if (isOK) {
                    telegram.sendData(result);
                }
            })
            
            return;
        }

        function closeOrder() {
            telegram.showConfirm("ç¢ºå®šæ‰‹å‹•å¹³å€‰?", function(isOK){
                if (isOK) {
                    telegram.sendData("closeOrder=" + id);
                }
            })
        }

        function cancelAdjust() {
            telegram.showConfirm("å–æ¶ˆæ›´æ–°?", function(isOK){
                if (isOK) {
                    telegram.sendData("cancelAdjustOrder");
                }
            })
        }
    </script>
</body>
</html>