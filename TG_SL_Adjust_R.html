<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç©º-èª¿æ•´å€‰ä½æ•¸å€¼</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body onload="initForm()">
    <div class="container mt-5">
        <h2>å¤šç©º-èª¿æ•´å€‰ä½æ•¸å€¼(ver:2025082401)</h2>
        <form id="mainForm">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="orderId"></label>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="long">ä½œå¤š</label>
                </div>
                <div class="form-group col-md-6">
                    <label id="short">ä½œç©º</label>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label id="RPercent">1Rå¹¾%:</label>
                </div>
                <div class="form-group col-md-6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="SL">SL (è‹¥åœæç‚ºæ­£æ•¸ä¸‹é¢é¸å–®è«‹é¸æ“‡æ­£)(å–®ä½ç‚ºR)</label>
                    <div class="form-inline">
                        <select class="form-control" id="isSLMinus">
                            <option value="SL_Minus" selected>è² </option>
                            <option value="SL_Plus">æ­£</option>
                        </select>
                        <input type="text" class="form-control" id="SL" placeholder="è¼¸å…¥SLçš„R">
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label for="TP">TP(å–®ä½ç‚ºR)</label>
                    <input type="text" class="form-control" id="TP" placeholder="è¼¸å…¥TPçš„R">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="preserveType">ä¿æœ¬/ç§»å‹•åœæ</label>
                    <select class="form-control" id="preserveType" onchange="toggleInputs()">
                        <option value="preserve" selected>ä¿æœ¬</option>
                        <option value="trailing">ç§»å‹•åœæ</option>
                        <option value="preserve_trailing">ä¿æœ¬+ç§»å‹•åœæ</option>
                        <option value="none">ä¸å•Ÿç”¨</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                </div>
            </div>
            <div class="form-row" id="preserveInputs">
                <div class="form-group col-md-6">
                    <label for="preservePercent">è‡ªå‹•ä¿æœ¬æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, è«‹è¼¸å…¥å¤§æ–¼0ä¹‹æ•¸å­—)</label>
                    <input type="text" class="form-control" id="preservePercent" placeholder="è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, 0ç‚ºä¸å•Ÿå‹•è‡ªå‹•ä¿æœ¬)">
                </div>
                <div class="form-group col-md-6">
                    <label for="savePercent">ä¿æœ¬Ræ•¸</label>
                    <input type="text" class="form-control" id="savePercent" placeholder="è¼¸å…¥ä¿æœ¬Ræ•¸">
                </div>
            </div>
            <div class="form-row" id="trailingInputs" style="display:none">
                <div class="form-group col-md-6">
                    <label for="trailingCondition">ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, è«‹è¼¸å…¥å¤§æ–¼0ä¹‹æ•¸å­—)</label>
                    <input type="text" class="form-control" id="trailingCondition" placeholder="è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶(æ¢ä»¶ç‚ºRæ•¸, 0ç‚ºä¸å•Ÿå‹•ç§»å‹•åœæ)">
                </div>
                <div class="form-group col-md-6">
                    <label for="trailingAmount">å›åç§»å‹•Ræ•¸</label>
                    <input type="text" class="form-control" id="trailingAmount" placeholder="è¼¸å…¥ç§»å‹•Ræ•¸">
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="submitAdjust()">æ›´æ–°è³‡æ–™</button>
            <button type="button" class="btn btn-primary" onclick="closeOrder()">æ‰‹å‹•å¹³å€‰</button>
            <button type="button" class="btn btn-primary" onclick="cancelAdjust()">å–æ¶ˆæ›´æ–°</button>
        </form>

        <!-- æ§“æ¡¿åˆ†æå»ºè­°å€åŸŸ -->
        <div id="leverage-analysis" class="mt-4 p-3 border rounded" style="display:none;">
            <h4>ğŸ” æ§“æ¡¿åˆ†æå»ºè­° <small class="text-muted">(åƒ…ä¾›åƒè€ƒ)</small></h4>

            <!-- æ§“æ¡¿åŸºæœ¬ä¿¡æ¯é¡¯ç¤ºå€åŸŸ -->
            <div id="leverage-info" class="mb-3">
                <!-- å‹•æ…‹æ›´æ–°çš„æ§“æ¡¿åŸºæœ¬ä¿¡æ¯ -->
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h6>åˆå§‹æŒå€‰åˆ†æ:</h6>
                    <div id="initial-position-info" class="small">
                        <div>â€¢ é•·å€‰: <span id="long-notional">-</span></div>
                        <div>â€¢ ç©ºå€‰: <span id="short-notional">-</span></div>
                        <div>â€¢ å¹³å‡åç¾©åƒ¹å€¼: <span id="avg-notional">-</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>åŠ ç¢¼è¨­å®šåˆ†æ:</h6>
                    <div id="scaling-config-info" class="small">
                        <div>â€¢ è¨­å®šä¸Šé™å€æ•¸: <span id="scaling-multiplier">-</span>x</div>
                        <div>â€¢ æœ€å¤§é æœŸæŒå€‰: <span id="max-expected">-</span></div>
                    </div>
                </div>
            </div>

            <!-- æŒå€‰å……è¶³æ€§é¡¯ç¤ºå€åŸŸ -->
            <div id="position-sufficiency" class="mb-3">
                <!-- å‹•æ…‹æ›´æ–°çš„æŒå€‰å……è¶³æ€§ä¿¡æ¯ -->
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>ç•¶å‰æ§“æ¡¿åˆ†æ (<span id="current-leverage-text">-</span>x):</h6>
                    <div id="current-leverage-status" class="small">
                        <div id="long-limit-status">â€¢ <span id="long-symbol-text">-</span> æŒå€‰ä¸Šé™: <span id="long-limit">-</span> <span id="long-sufficient">-</span></div>
                        <div id="short-limit-status">â€¢ <span id="short-symbol-text">-</span> æŒå€‰ä¸Šé™: <span id="short-limit">-</span> <span id="short-sufficient">-</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>ä¿è­‰é‡‘éœ€æ±‚:</h6>
                    <div id="margin-analysis" class="small">
                        <div>â€¢ ç›®å‰ä¿è­‰é‡‘: <span id="current-margin">-</span></div>
                        <div>â€¢ æœ€å¤§ä¿è­‰é‡‘: <span id="max-margin">-</span></div>
                        <div>â€¢ ä¿è­‰é‡‘å¢åŠ : <span id="margin-increase">-</span></div>
                    </div>
                </div>
            </div>

            <div id="leverage-recommendation" class="mt-3 p-2 rounded">
                <!-- å‹•æ…‹é¡¯ç¤ºå»ºè­°å…§å®¹ -->
            </div>

            <!-- æ§“æ¡¿èª¿æ•´æ§åˆ¶é … -->
            <div id="leverage-adjustment-controls" class="mt-3" style="display:none;">
                <div class="form-group row">
                    <label for="newLeverage" class="col-sm-3 col-form-label">èª¿æ•´æ§“æ¡¿è‡³:</label>
                    <div class="col-sm-4">
                        <select class="form-control" id="newLeverage">
                            <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
                        </select>
                    </div>
                    <div class="col-sm-5">
                        <small class="text-muted form-text">èª¿æ•´å°‡åŒæ™‚å½±éŸ¿é•·å€‰å’Œç©ºå€‰</small>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="leverage-confirm-checkbox">
                        <label class="form-check-label" for="confirmLeverageAdjust">
                            æˆ‘äº†è§£æ§“æ¡¿èª¿æ•´çš„é¢¨éšªä¸¦ç¢ºèªåŸ·è¡Œ
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-2">
                <small class="text-muted">
                    âš ï¸ æ­¤ç‚ºåˆ†æå»ºè­°ï¼Œå¯¦éš›èª¿æ•´è«‹è‡ªè¡Œæ±ºå®š<br>
                    ğŸ’¡ æ§“æ¡¿èª¿æ•´ä¸å½±éŸ¿é¢¨éšªæ§åˆ¶é‚è¼¯ï¼Œé¢¨éšªä»ç”±åœæä½ç½®æ§ç®¡
                </small>
            </div>
        </div>

        <br/>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('click', (event) => {
            const tags = ['INPUT', 'TEXTAREA']
            const focused = document.activeElement
            // console.log(focused.tagName)

            if (focused && focused !== event.target && tags.includes(focused.tagName)) {
                focused.blur()
            }
        })
        
        const telegram = Telegram.WebApp;
        telegram.ready();
        id = '';
        long = '';
        short = '';
        RPercent = 0;
        function initForm() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            RPercent = urlParams.get('RPercent');
            document.getElementById('RPercent').innerHTML = '1Rå¹¾%:' + RPercent + '%';
            document.getElementById('orderId').innerHTML = urlParams.get('id');
            id = urlParams.get('id');
            document.getElementById('long').innerHTML = 'ä½œå¤š:' + urlParams.get('long');
            long = urlParams.get('long');
            document.getElementById('short').innerHTML = 'ä½œç©º:' + urlParams.get('short');
            short = urlParams.get('short');
            document.getElementById('SL').value = Number(Math.abs(urlParams.get('sl')/RPercent).toFixed(3));
            if(urlParams.get('sl') < 0) {
                document.getElementById('isSLMinus').value = 'SL_Minus';
            } else {
                document.getElementById('isSLMinus').value = 'SL_Plus';
            }
            document.getElementById('TP').value = Number((urlParams.get('tp')/RPercent).toFixed(3));
            document.getElementById('preservePercent').value = Number((urlParams.get('preservePercent')/RPercent).toFixed(3));
            document.getElementById('savePercent').value = Number((urlParams.get('savePercent')/RPercent).toFixed(3));
            document.getElementById('trailingCondition').value = Number((urlParams.get('trailingCondition')/RPercent).toFixed(3));
            document.getElementById('trailingAmount').value = Number((urlParams.get('trailingAmount')/RPercent).toFixed(3));
            // åˆ¤æ–·ç•¶å‰çš„ä¿æœ¬/ç§»å‹•åœææ¨¡å¼
            const hasPreserve = urlParams.get('preservePercent') != 0 && urlParams.get('savePercent') != 0;
            const hasTrailing = urlParams.get('trailingCondition') != 0 && urlParams.get('trailingAmount') != 0;
            
            if (hasPreserve && hasTrailing) {
                document.getElementById('preserveType').value = 'preserve_trailing';
            } else if (hasPreserve) {
                document.getElementById('preserveType').value = 'preserve';
            } else if (hasTrailing) {
                document.getElementById('preserveType').value = 'trailing';
            } else {
                document.getElementById('preserveType').value = 'none';
            }
            toggleInputs();

            // æ§“æ¡¿åˆ†æåƒæ•¸è§£æ
            initLeverageAnalysis(urlParams);
        }

        function initLeverageAnalysis(urlParams) {
            // è§£ææ§“æ¡¿åˆ†æç›¸é—œåƒæ•¸
            const leverage = urlParams.get('leverage');
            const needsLeverageAdjustment = urlParams.get('needsLeverageAdjustment') === 'true';
            const suggestedLeverage = urlParams.get('suggestedLeverage');
            const maxExpectedNotional = urlParams.get('maxExpectedNotional');
            const currentMargin = urlParams.get('currentMargin');
            const maxMargin = urlParams.get('maxMargin');
            const longSufficient = urlParams.get('longSufficient') === 'true';
            const shortSufficient = urlParams.get('shortSufficient') === 'true';

            // è§£ææ–°å¢çš„æ§“æ¡¿åˆ†æåƒæ•¸
            const scalingMultiplier = urlParams.get('scalingMultiplier') || '5';
            const longLimit = parseFloat(urlParams.get('longLimit')) || 0;
            const shortLimit = parseFloat(urlParams.get('shortLimit')) || 0;
            const longSymbol = urlParams.get('longSymbol') || '-';
            const shortSymbol = urlParams.get('shortSymbol') || '-';

            // æ›´æ–°æ§“æ¡¿åˆ†æé¡¯ç¤ºå€åŸŸ
            if (leverage) {
                const analysisSection = document.getElementById('leverage-analysis');
                analysisSection.style.display = 'block';

                // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                const longNotional = parseFloat(urlParams.get('longNotional')) || 0;
                const shortNotional = parseFloat(urlParams.get('shortNotional')) || 0;

                // æ›´æ–°åŸºæœ¬ä¿¡æ¯åˆ°å°æ‡‰çš„HTMLå…ƒç´ 
                document.getElementById('current-leverage-text').textContent = leverage;
                document.getElementById('long-notional').textContent = `$${longNotional.toFixed(2)}`;
                document.getElementById('short-notional').textContent = `$${shortNotional.toFixed(2)}`;
                document.getElementById('avg-notional').textContent = `$${((longNotional + shortNotional) / 2).toFixed(2)}`;
                document.getElementById('max-expected').textContent = `$${parseFloat(maxExpectedNotional || 0).toFixed(2)}`;
                document.getElementById('current-margin').textContent = `$${parseFloat(currentMargin || 0).toFixed(2)}`;
                document.getElementById('max-margin').textContent = `$${parseFloat(maxMargin || 0).toFixed(2)}`;
                document.getElementById('margin-increase').textContent = `$${(parseFloat(maxMargin || 0) - parseFloat(currentMargin || 0)).toFixed(2)}`;

                // æ›´æ–°æ–°å¢çš„æ§“æ¡¿åˆ†æé¡¯ç¤ºå…ƒç´ 
                if (document.getElementById('scaling-multiplier')) {
                    document.getElementById('scaling-multiplier').textContent = scalingMultiplier;
                }
                if (document.getElementById('long-limit')) {
                    document.getElementById('long-limit').textContent = `$${longLimit.toFixed(0)}`;
                }
                if (document.getElementById('short-limit')) {
                    document.getElementById('short-limit').textContent = `$${shortLimit.toFixed(0)}`;
                }
                if (document.getElementById('long-symbol-text')) {
                    document.getElementById('long-symbol-text').textContent = longSymbol;
                }
                if (document.getElementById('short-symbol-text')) {
                    document.getElementById('short-symbol-text').textContent = shortSymbol;
                }

                // æ›´æ–°æŒå€‰å……è¶³æ€§ç‹€æ…‹
                document.getElementById('long-sufficient').innerHTML = `${longSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}`;
                document.getElementById('short-sufficient').innerHTML = `${shortSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}`;

                // æ›´æ–° leverage-info å€åŸŸï¼ˆé¡¯ç¤ºå½™ç¸½ä¿¡æ¯ï¼‰
                document.getElementById('leverage-info').innerHTML = `
                    <div class="row">
                        <div class="col-sm-6"><strong>ç›®å‰æ§“æ¡¿:</strong> ${leverage}x</div>
                        <div class="col-sm-6"><strong>ç¸½é«”ç‹€æ…‹:</strong> ${(longSufficient && shortSufficient) ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:orange">âš ï¸ éœ€æ³¨æ„</span>'}</div>
                    </div>
                `;

                // æ›´æ–° position-sufficiency å€åŸŸï¼ˆè©³ç´°æŒå€‰åˆ†æï¼‰
                document.getElementById('position-sufficiency').innerHTML = `
                    <div class="row">
                        <div class="col-sm-6">
                            <small><strong>é•·å€‰å……è¶³æ€§:</strong> ${longSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}</small>
                        </div>
                        <div class="col-sm-6">
                            <small><strong>ç©ºå€‰å……è¶³æ€§:</strong> ${shortSufficient ? '<span style="color:green">âœ… å……è¶³</span>' : '<span style="color:red">âŒ ä¸è¶³</span>'}</small>
                        </div>
                    </div>
                `;

                // æ›´æ–°å»ºè­°èˆ‡æ§åˆ¶
                const recommendationDiv = document.getElementById('leverage-recommendation');
                const adjustmentControlsDiv = document.getElementById('leverage-adjustment-controls');

                // æ ¹æ“šæ˜¯å¦æœ‰å»ºè­°é¡¯ç¤ºä¸åŒçš„å»ºè­°æ–‡å­—
                if (needsLeverageAdjustment && suggestedLeverage) {
                    recommendationDiv.innerHTML = `
                        <div class="recommendation-warning">
                            âš ï¸ ç³»çµ±å»ºè­°èª¿æ•´æ§“æ¡¿è‡³: ${suggestedLeverage}x
                        </div>
                    `;
                } else {
                    recommendationDiv.innerHTML = `
                        <div class="recommendation-ok">
                            âœ… ç›®å‰æ§“æ¡¿å……è¶³ï¼Œç„¡éœ€èª¿æ•´
                            <br><small>ğŸ”§ æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•èª¿æ•´æ§“æ¡¿ (å¯é¸)</small>
                        </div>
                    `;
                }

                // å§‹çµ‚é¡¯ç¤ºèª¿æ•´æ§åˆ¶é …ï¼Œè®“ç”¨æˆ¶éš¨æ™‚å¯ä»¥èª¿æ•´
                adjustmentControlsDiv.style.display = 'block';

                // ç”Ÿæˆæ§“æ¡¿é¸é …
                const leverageSelect = document.getElementById('newLeverage');
                leverageSelect.innerHTML = '';

                // å¸¸è¦‹æ§“æ¡¿é¸é …
                const leverageOptions = [5, 10, 15, 20, 25, 30, 50, 75, 100, 125];
                const currentLev = parseInt(leverage);
                const suggestedLev = parseInt(suggestedLeverage);

                leverageOptions.forEach(lev => {
                    const option = document.createElement('option');
                    option.value = lev;
                    option.textContent = lev + 'x';

                    // æ¨™è¨˜ç•¶å‰æ§“æ¡¿
                    if (lev === currentLev) {
                        option.textContent += ' (ç›®å‰)';
                        option.selected = true;
                    }
                    // å¦‚æœæœ‰å»ºè­°ä¸”ä¸æ˜¯ç•¶å‰æ§“æ¡¿ï¼Œæ¨™è¨˜å»ºè­°
                    else if (needsLeverageAdjustment && lev === suggestedLev) {
                        option.textContent += ' (å»ºè­°)';
                    }

                    leverageSelect.appendChild(option);
                });

                // å¦‚æœå»ºè­°æ§“æ¡¿ä¸åœ¨å¸¸è¦‹é¸é …ä¸­ï¼Œæ·»åŠ å®ƒ
                if (needsLeverageAdjustment && suggestedLev && !leverageOptions.includes(suggestedLev)) {
                    const suggestedOption = document.createElement('option');
                    suggestedOption.value = suggestedLev;
                    suggestedOption.textContent = suggestedLev + 'x (å»ºè­°)';
                    leverageSelect.appendChild(suggestedOption);
                }
            } else {
                // å¦‚æœæ²’æœ‰æ§“æ¡¿åˆ†ææ•¸æ“šï¼Œéš±è—æ•´å€‹å€åŸŸ
                document.getElementById('leverage-analysis').style.display = 'none';
            }
        }

        function toggleInputs() {
            const type = document.getElementById('preserveType').value;
            document.getElementById('preserveInputs').style.display = 
                (type === 'preserve' || type === 'preserve_trailing') ? 'flex' : 'none';
            document.getElementById('trailingInputs').style.display = 
                (type === 'trailing' || type === 'preserve_trailing') ? 'flex' : 'none';
        }

        function submitAdjust() {
            var SL = document.getElementById('SL').value;
            const isSLMinus = document.getElementById('isSLMinus').value;
            let TP = document.getElementById('TP').value;
            let preservePercent = parseFloat(document.getElementById('preservePercent').value);
            let savePercent = parseFloat(document.getElementById('savePercent').value);
            let trailingCondition = parseFloat(document.getElementById('trailingCondition').value);
            let trailingAmount = parseFloat(document.getElementById('trailingAmount').value);
            const preserveType = document.getElementById('preserveType').value;

            // æ§“æ¡¿èª¿æ•´ç›¸é—œè®Šæ•¸
            let newLeverage = '';
            let isLeverageAdjustment = false;
            const leverageAnalysisSection = document.getElementById('leverage-analysis');
            const leverageCheckbox = document.getElementById('leverage-confirm-checkbox');
            const leverageSelect = document.getElementById('newLeverage');

            // æª¢æŸ¥æ˜¯å¦æœ‰æ§“æ¡¿åˆ†æä¸”ç”¨æˆ¶é¸æ“‡è¦èª¿æ•´
            if (leverageAnalysisSection && leverageAnalysisSection.style.display !== 'none') {
                const adjustmentControls = document.getElementById('leverage-adjustment-controls');
                if (adjustmentControls && adjustmentControls.style.display !== 'none') {
                    // æª¢æŸ¥ç¢ºèªå‹¾é¸æ¡†
                    if (leverageCheckbox && leverageCheckbox.checked) {
                        if (leverageSelect && leverageSelect.value) {
                            newLeverage = leverageSelect.value;
                            isLeverageAdjustment = true;
                        } else {
                            alert('è«‹é¸æ“‡æ–°çš„æ§“æ¡¿å€¼');
                            return;
                        }
                    }
                }
            }

            if (SL === '' || TP === '') {
                alert('è«‹è¼¸å…¥SL, TP');
                return;
            }

            if (isNaN(SL) || isNaN(TP)) {
                alert('SL, TP, å¿…é ˆç‚ºæ•¸å­—');
                return;
            }

            if (preserveType === 'preserve') {
                if (preservePercent === '') {
                    alert('è«‹è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶');
                    return;
                }
                if (savePercent === '') {
                    alert('è«‹è¼¸å…¥ä¿æœ¬Ræ•¸');
                    return;
                }
                if (isNaN(preservePercent) || isNaN(savePercent)) {
                    alert('è‡ªå‹•ä¿æœ¬æ¢ä»¶å’Œä¿æœ¬Ræ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (preservePercent <= 0 || savePercent <= 0) {
                    alert('è‡ªå‹•ä¿æœ¬æ¢ä»¶å’Œä¿æœ¬Ræ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
            } else if (preserveType === 'trailing') {
                if (trailingCondition === '') {
                    alert('è«‹è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶');
                    return;
                }
                if (trailingAmount === '') {
                    alert('è«‹è¼¸å…¥å›åç§»å‹•Ræ•¸');
                    return;
                }
                if (isNaN(trailingCondition) || isNaN(trailingAmount)) {
                    alert('ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶å’Œå›åç§»å‹•Ræ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (trailingCondition <= 0 || trailingAmount <= 0) {
                    alert('ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶å’Œå›åç§»å‹•Ræ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
            } else if (preserveType === 'preserve_trailing') {
                // ä¿æœ¬+ç§»å‹•åœææ¨¡å¼çš„é©—è­‰
                if (preservePercent === '') {
                    alert('è«‹è¼¸å…¥è‡ªå‹•ä¿æœ¬æ¢ä»¶');
                    return;
                }
                if (savePercent === '') {
                    alert('è«‹è¼¸å…¥ä¿æœ¬Ræ•¸');
                    return;
                }
                if (trailingCondition === '') {
                    alert('è«‹è¼¸å…¥ç§»å‹•åœæå•Ÿå‹•æ¢ä»¶');
                    return;
                }
                if (trailingAmount === '') {
                    alert('è«‹è¼¸å…¥å›åç§»å‹•Ræ•¸');
                    return;
                }
                if (isNaN(preservePercent) || isNaN(savePercent) || isNaN(trailingCondition) || isNaN(trailingAmount)) {
                    alert('æ‰€æœ‰åƒæ•¸å¿…é ˆç‚ºæ•¸å­—');
                    return;
                }
                if (preservePercent <= 0 || savePercent <= 0 || trailingCondition <= 0 || trailingAmount <= 0) {
                    alert('æ‰€æœ‰åƒæ•¸å¿…é ˆç‚ºå¤§æ–¼0çš„æ•¸å­—');
                    return;
                }
                // é—œéµé©—è­‰ï¼šä¿æœ¬å•Ÿå‹•Ræ•¸ä¸å¯å¤§æ–¼ç­‰æ–¼ç§»å‹•åœæå•Ÿå‹•Ræ•¸
                if (parseFloat(preservePercent) >= parseFloat(trailingCondition)) {
                    alert('ä¿æœ¬å•Ÿå‹•Ræ•¸ä¸å¯å¤§æ–¼ç­‰æ–¼ç§»å‹•åœæå•Ÿå‹•Ræ•¸');
                    return;
                }
            }
            
            // æ ¹æ“šé¸æ“‡çš„æ¨¡å¼è¨­å®šåƒæ•¸
            if (preserveType === 'none') {
                preservePercent = 0;
                savePercent = 0;
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'preserve') {
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'trailing') {
                preservePercent = 0;
                savePercent = 0;
            }

            
            if (isSLMinus === 'SL_Minus') {
                SL = -SL;
            }
            const orig_SL = SL;
            const orig_TP = TP;
            const orig_preservePercent = preservePercent;
            const orig_savePercent = savePercent;
            const orig_trailingCondition = trailingCondition;
            const orig_trailingAmount = trailingAmount;

            SL = Number((SL * RPercent).toFixed(3));
            TP = Number(Math.abs(TP * RPercent).toFixed(3));
            if (preserveType === 'preserve') {
                preservePercent = Number(Math.abs(preservePercent * RPercent).toFixed(3));
                savePercent = Number(Math.abs(savePercent * RPercent).toFixed(3));
                trailingCondition = 0;
                trailingAmount = 0;
            } else if (preserveType === 'trailing') {
                trailingCondition = Number(Math.abs(trailingCondition * RPercent).toFixed(3));
                trailingAmount = Number(Math.abs(trailingAmount * RPercent).toFixed(3));
                preservePercent = 0;
                savePercent = 0;
            } else if (preserveType === 'preserve_trailing') {
                preservePercent = Number(Math.abs(preservePercent * RPercent).toFixed(3));
                savePercent = Number(Math.abs(savePercent * RPercent).toFixed(3));
                trailingCondition = Number(Math.abs(trailingCondition * RPercent).toFixed(3));
                trailingAmount = Number(Math.abs(trailingAmount * RPercent).toFixed(3));
            } else {
                preservePercent = 0;
                savePercent = 0;
                trailingCondition = 0;
                trailingAmount = 0;
            }
            
            var result = '';
            result = 'id=' + id + '&SL=' + SL + '&TP=' + TP + '&preservePercent=' + preservePercent + '&savePercent=' + savePercent + '&trailingCondition=' + trailingCondition + '&trailingAmount=' + trailingAmount + '&preserveType=' + preserveType;

            // æ·»åŠ æ§“æ¡¿èª¿æ•´åƒæ•¸
            if (isLeverageAdjustment) {
                result += '&newLeverage=' + newLeverage;
            }
            var checkResult = 'è«‹ç¢ºèªä¿®æ”¹åƒæ•¸:\nä½œå¤š:' + long + '\nä½œç©º:' + short + '\n1Rå¹¾%:'+ RPercent + '%\nSL:' + SL + '%('+ orig_SL + 'R)\nTP:' + TP + '%(' + orig_TP +'R)';
            if (preserveType === 'preserve') {
                checkResult += '\nè‡ªå‹•ä¿æœ¬æ¢ä»¶:' + preservePercent + '%(' + orig_preservePercent + 'R)\nä¿æœ¬Ræ•¸:' + savePercent + '%(' + orig_savePercent + 'R)';
            } else if (preserveType === 'trailing') {
                checkResult += '\nç§»å‹•åœææ¢ä»¶:' + trailingCondition + '%(' + orig_trailingCondition + 'R)\nå›åç§»å‹•Ræ•¸:' + trailingAmount + '%(' + orig_trailingAmount + 'R)';
            } else if (preserveType === 'preserve_trailing') {
                checkResult += '\nä¿æœ¬+ç§»å‹•åœææ¨¡å¼\nè‡ªå‹•ä¿æœ¬æ¢ä»¶:' + preservePercent + '%(' + orig_preservePercent + 'R)\nä¿æœ¬Ræ•¸:' + savePercent + '%(' + orig_savePercent + 'R)\nç§»å‹•åœææ¢ä»¶:' + trailingCondition + '%(' + orig_trailingCondition + 'R)\nå›åç§»å‹•Ræ•¸:' + trailingAmount + '%(' + orig_trailingAmount + 'R)';
            } else {
                checkResult += '\nä¸å•Ÿç”¨ä¿æœ¬/ç§»å‹•åœæ';
            }

            // æ·»åŠ æ§“æ¡¿èª¿æ•´ç¢ºèªä¿¡æ¯
            if (isLeverageAdjustment) {
                checkResult += '\n\nğŸ”§ æ§“æ¡¿èª¿æ•´:\næ–°æ§“æ¡¿: ' + newLeverage + 'x';
                checkResult += '\nâš ï¸ æ³¨æ„: èª¿æ•´æ§“æ¡¿æœƒåŒæ™‚å½±éŸ¿é•·å€‰å’Œç©ºå€‰';
            }

            telegram.showConfirm(checkResult, function(isOK){
                if (isOK) {
                    telegram.sendData(result);
                }
            })
            
            return;
        }

        function closeOrder() {
            telegram.showConfirm("ç¢ºå®šæ‰‹å‹•å¹³å€‰?", function(isOK){
                if (isOK) {
                    telegram.sendData("closeOrder=" + id);
                }
            })
        }

        function cancelAdjust() {
            telegram.showConfirm("å–æ¶ˆæ›´æ–°?", function(isOK){
                if (isOK) {
                    telegram.sendData("cancelAdjustOrder");
                }
            })
        }
    </script>
</body>
</html>